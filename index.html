
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>StudyBuddy</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Baloo+2:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
:root {
  --bg: #e8e0f0;
  --surface: rgba(255,255,255,0.75);
  --surface2: rgba(255,255,255,0.55);
  --surface3: rgba(255,255,255,0.35);
  --border: rgba(180,160,220,0.35);
  --border2: rgba(160,140,200,0.45);
  --glass: rgba(255,255,255,0.6);
  --glass2: rgba(255,255,255,0.4);
  --purple: #8b5cf6;
  --purple-l: #a78bfa;
  --purple-d: #6d28d9;
  --purple-g: rgba(139,92,246,0.18);
  --pink: #ec4899;
  --pink-l: #f472b6;
  --pink-soft: rgba(236,72,153,0.12);
  --yellow: #fbbf24;
  --yellow-l: #fcd34d;
  --yellow-soft: rgba(251,191,36,0.15);
  --green: #10b981;
  --green-l: #34d399;
  --green-soft: rgba(16,185,129,0.12);
  --blue: #3b82f6;
  --blue-l: #60a5fa;
  --blue-soft: rgba(59,130,246,0.12);
  --orange: #f97316;
  --orange-l: #fb923c;
  --orange-soft: rgba(249,115,22,0.12);
  --teal: #14b8a6;
  --teal-l: #2dd4bf;
  --teal-soft: rgba(20,184,166,0.12);
  --red: #ef4444;
  --red-soft: rgba(239,68,68,0.12);
  --text: #2d1b69;
  --text2: #6b5b95;
  --text3: #9b8ec4;
  --shadow: rgba(100,60,180,0.12);
  --shadow2: rgba(100,60,180,0.2);
  --r: 20px;
  --r-sm: 14px;
  --r-lg: 28px;
  --r-xl: 36px;
  --transition: 0.35s cubic-bezier(0.4,0,0.2,1);
  --bounce: 0.5s cubic-bezier(0.34,1.56,0.64,1);
  --smooth: cubic-bezier(0.22, 1, 0.36, 1);
}
[data-theme="dark"] {
  --bg: #0f0b1a;
  --surface: rgba(30,24,55,0.85);
  --surface2: rgba(40,32,70,0.75);
  --surface3: rgba(50,40,85,0.6);
  --border: rgba(100,80,160,0.3);
  --border2: rgba(120,100,180,0.35);
  --glass: rgba(30,24,55,0.7);
  --glass2: rgba(40,32,70,0.5);
  --text: #f0e8ff;
  --text2: #b0a0d0;
  --text3: #6a5a90;
  --shadow: rgba(0,0,0,0.3);
  --shadow2: rgba(0,0,0,0.4);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Nunito',sans-serif;overflow:hidden;user-select:none;transition:background var(--transition),color var(--transition);}
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px;}

/* ══════════ BACKGROUND ORBS ══════════ */
.app-bg{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden;transition:opacity var(--transition);}
.bg-orb{position:absolute;border-radius:50%;filter:blur(80px);opacity:0.3;will-change:transform;transition:opacity 1s ease;}
[data-theme="dark"] .bg-orb{opacity:0.15;}
.bg-orb-1{width:300px;height:300px;background:#c084fc;top:-80px;right:-60px;animation:orbFloat 8s ease-in-out infinite;}
.bg-orb-2{width:250px;height:250px;background:#818cf8;bottom:100px;left:-80px;animation:orbFloat 10s ease-in-out infinite reverse;}
.bg-orb-3{width:200px;height:200px;background:#f0abfc;top:40%;left:50%;animation:orbFloat 12s ease-in-out infinite 2s;}
.bg-orb-4{width:180px;height:180px;background:#67e8f9;bottom:200px;right:-40px;animation:orbFloat 9s ease-in-out infinite 1s;}
@keyframes orbFloat{0%,100%{transform:translateY(0) scale(1);}50%{transform:translateY(-30px) scale(1.1);}}

/* ══════════ EPIC SPLASH SCREEN ══════════ */
#splash{position:fixed;inset:0;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden;}

/* Animated gradient background */
.splash-bg{position:absolute;inset:0;background:linear-gradient(160deg,#ede5ff 0%,#c8b6ff 25%,#9b72cf 50%,#6d28d9 75%,#4c1d95 100%);background-size:400% 400%;animation:splashGradient 4s ease infinite;}
@keyframes splashGradient{0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;}}

/* Floating particles in splash */
.splash-particles{position:absolute;inset:0;overflow:hidden;}
.splash-particle{position:absolute;border-radius:50%;background:rgba(255,255,255,0.15);animation:splashParticleFloat linear infinite;}
@keyframes splashParticleFloat{
  0%{transform:translateY(100vh) rotate(0deg);opacity:0;}
  10%{opacity:1;}
  90%{opacity:1;}
  100%{transform:translateY(-10vh) rotate(720deg);opacity:0;}
}

/* Concentric rings animation */
.splash-rings{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;}
.splash-ring{position:absolute;border-radius:50%;border:1.5px solid rgba(255,255,255,0.1);animation:ringExpand 3s ease-out infinite;}
.splash-ring:nth-child(1){width:100px;height:100px;animation-delay:0s;}
.splash-ring:nth-child(2){width:180px;height:180px;animation-delay:0.5s;}
.splash-ring:nth-child(3){width:260px;height:260px;animation-delay:1s;}
.splash-ring:nth-child(4){width:340px;height:340px;animation-delay:1.5s;}
@keyframes ringExpand{
  0%{transform:scale(0.5);opacity:0.6;border-color:rgba(255,255,255,0.2);}
  100%{transform:scale(2);opacity:0;border-color:rgba(255,255,255,0);}
}

/* Logo entry */
.splash-logo-wrap{position:relative;z-index:2;display:flex;flex-direction:column;align-items:center;opacity:0;transform:scale(0.3) translateY(30px);animation:splashLogoEntry 1s cubic-bezier(0.34,1.56,0.64,1) 0.5s forwards;}
@keyframes splashLogoEntry{
  0%{opacity:0;transform:scale(0.3) translateY(30px) rotate(-10deg);}
  60%{opacity:1;transform:scale(1.08) translateY(-5px) rotate(2deg);}
  100%{opacity:1;transform:scale(1) translateY(0) rotate(0deg);}
}

/* Logo */
.logo-mark{position:relative;width:120px;height:120px;margin-bottom:20px;}
.logo-book{width:80px;height:65px;position:absolute;bottom:18px;left:50%;transform:translateX(-50%);border-radius:6px 16px 16px 6px;background:linear-gradient(135deg,#8b5cf6,#a855f7);box-shadow:0 8px 30px rgba(139,92,246,0.5);animation:bookGlow 2s ease-in-out infinite alternate;}
@keyframes bookGlow{0%{box-shadow:0 8px 30px rgba(139,92,246,0.4);}100%{box-shadow:0 12px 40px rgba(139,92,246,0.7),0 0 60px rgba(139,92,246,0.2);}}
.logo-book::before{content:'';position:absolute;left:0;top:0;bottom:0;width:10px;border-radius:6px 0 0 6px;background:linear-gradient(180deg,#6d28d9,#5b21b6);}
.logo-book::after{content:'';position:absolute;right:8px;top:8px;bottom:8px;left:18px;border-radius:3px;background:rgba(255,255,255,0.2);border-top:2px solid rgba(255,255,255,0.3);border-bottom:2px solid rgba(255,255,255,0.3);}
.logo-sparkle{position:absolute;font-size:20px;animation:sparkleFloat 2s ease-in-out infinite;opacity:0;}
.splash-logo-wrap .logo-sparkle{animation:sparkleEntry 0.5s ease forwards, sparkleFloat 2s ease-in-out 1.5s infinite;}
.logo-sparkle-1{top:0;right:10px;animation-delay:1.2s,1.5s;}
.logo-sparkle-2{top:8px;left:5px;font-size:14px;animation-delay:1.4s,1.5s;}
.logo-sparkle-3{top:2px;right:35px;font-size:16px;animation-delay:1.6s,1.5s;}
@keyframes sparkleEntry{0%{opacity:0;transform:scale(0) rotate(-180deg);}100%{opacity:1;transform:scale(1) rotate(0deg);}}
@keyframes sparkleFloat{0%,100%{transform:translateY(0) scale(1);opacity:0.8;}50%{transform:translateY(-6px) scale(1.2);opacity:1;}}
.logo-brain{position:absolute;top:5px;left:50%;transform:translateX(-50%);font-size:36px;opacity:0;animation:brainEntry 0.6s cubic-bezier(0.34,1.56,0.64,1) 0.8s forwards,brainBounce 2s ease-in-out 1.8s infinite;}
@keyframes brainEntry{0%{opacity:0;transform:translateX(-50%) translateY(-20px) scale(0.5);}100%{opacity:1;transform:translateX(-50%) translateY(0) scale(1);}}
@keyframes brainBounce{0%,100%{transform:translateX(-50%) translateY(0);}50%{transform:translateX(-50%) translateY(-5px);}}
.logo-ring{position:absolute;inset:-5px;border-radius:50%;border:3px solid transparent;border-top-color:rgba(255,255,255,0.4);border-right-color:rgba(251,191,36,0.4);animation:logoRingSpin 3s linear infinite;opacity:0;animation:logoRingEntry 0.5s ease 1s forwards, logoRingSpin 3s linear 1.5s infinite;}
@keyframes logoRingEntry{0%{opacity:0;transform:scale(0.5);}100%{opacity:1;transform:scale(1);}}
@keyframes logoRingSpin{to{transform:rotate(360deg);}}

/* Title animation */
.splash-title{font-family:'Baloo 2',sans-serif;font-size:38px;font-weight:800;color:#fff;margin-bottom:6px;letter-spacing:-0.02em;text-shadow:0 4px 20px rgba(0,0,0,0.2);opacity:0;animation:titleSlideUp 0.7s var(--smooth) 1.1s forwards;}
.splash-tagline{font-size:14px;color:rgba(255,255,255,0.8);text-align:center;line-height:1.6;max-width:260px;opacity:0;animation:titleSlideUp 0.7s var(--smooth) 1.3s forwards;}
@keyframes titleSlideUp{0%{opacity:0;transform:translateY(20px);}100%{opacity:1;transform:translateY(0);}}

/* Loading bar instead of dots */
.splash-loader{margin-top:40px;width:160px;height:4px;border-radius:4px;background:rgba(255,255,255,0.15);overflow:hidden;opacity:0;animation:titleSlideUp 0.5s var(--smooth) 1.6s forwards;}
.splash-loader-fill{height:100%;width:0%;border-radius:4px;background:linear-gradient(90deg,#fbbf24,#f472b6,#a78bfa,#60a5fa);background-size:200% 100%;animation:loaderFill 2s cubic-bezier(0.4,0,0.2,1) 1.8s forwards, loaderShimmer 1s ease infinite;}
@keyframes loaderFill{0%{width:0%;}100%{width:100%;}}
@keyframes loaderShimmer{0%{background-position:200% 0;}100%{background-position:-200% 0;}}

.splash-ready{position:absolute;bottom:60px;font-size:12px;font-weight:700;color:rgba(255,255,255,0.5);letter-spacing:0.1em;text-transform:uppercase;opacity:0;animation:titleSlideUp 0.5s var(--smooth) 2s forwards;}

/* Splash exit */
#splash.exit{animation:splashExit 0.8s cubic-bezier(0.4,0,0.2,1) forwards;}
#splash.exit .splash-logo-wrap{animation:splashLogoExit 0.5s var(--smooth) forwards;}
#splash.exit .splash-bg{animation:splashBgExit 0.8s ease forwards;}
@keyframes splashExit{
  0%{opacity:1;transform:scale(1);}
  100%{opacity:0;transform:scale(1.15);pointer-events:none;}
}
@keyframes splashLogoExit{
  0%{opacity:1;transform:scale(1);}
  100%{opacity:0;transform:scale(0.8) translateY(-30px);}
}
@keyframes splashBgExit{
  0%{opacity:1;}
  100%{opacity:0;}
}

.particle{position:fixed;border-radius:50%;pointer-events:none;z-index:99998;will-change:transform,opacity;animation:particleFly 1s ease-out forwards;}
@keyframes particleFly{0%{opacity:1;transform:translate(0,0) scale(1);}100%{opacity:0;transform:translate(var(--tx),var(--ty)) scale(0);}}

/* ══════════ SCREEN TRANSITIONS - FIXED & SMOOTH ══════════ */
.screen{
  display:none;
  flex-direction:column;
  flex:1;
  overflow:hidden;
  position:relative;
  z-index:1;
  will-change:transform, opacity;
}
.screen.active{
  display:flex;
}
.screen.entering{
  animation:screenEnter 0.5s var(--smooth) forwards;
}
.screen.exiting{
  animation:screenExit 0.35s var(--smooth) forwards;
  pointer-events:none;
}

@keyframes screenEnter{
  0%{opacity:0;transform:translateY(24px) scale(0.97);}
  100%{opacity:1;transform:translateY(0) scale(1);}
}
@keyframes screenExit{
  0%{opacity:1;transform:translateY(0) scale(1);}
  100%{opacity:0;transform:translateY(-16px) scale(0.98);}
}

/* Directional nav transitions */
.screen.entering-left{animation:enterLeft 0.5s var(--smooth) forwards;}
.screen.entering-right{animation:enterRight 0.5s var(--smooth) forwards;}
.screen.exiting-left{animation:exitLeft 0.35s var(--smooth) forwards;pointer-events:none;}
.screen.exiting-right{animation:exitRight 0.35s var(--smooth) forwards;pointer-events:none;}

@keyframes enterLeft{
  0%{opacity:0;transform:translateX(50px) scale(0.98);}
  100%{opacity:1;transform:translateX(0) scale(1);}
}
@keyframes enterRight{
  0%{opacity:0;transform:translateX(-50px) scale(0.98);}
  100%{opacity:1;transform:translateX(0) scale(1);}
}
@keyframes exitLeft{
  0%{opacity:1;transform:translateX(0) scale(1);}
  100%{opacity:0;transform:translateX(-30px) scale(0.98);}
}
@keyframes exitRight{
  0%{opacity:1;transform:translateX(0) scale(1);}
  100%{opacity:0;transform:translateX(30px) scale(0.98);}
}

/* Sub-screen enter (for tech tools) */
.screen.entering-up{animation:enterUp 0.5s var(--smooth) forwards;}
.screen.exiting-down{animation:exitDown 0.35s var(--smooth) forwards;pointer-events:none;}

@keyframes enterUp{
  0%{opacity:0;transform:translateY(60px) scale(0.96);}
  100%{opacity:1;transform:translateY(0) scale(1);}
}
@keyframes exitDown{
  0%{opacity:1;transform:translateY(0) scale(1);}
  100%{opacity:0;transform:translateY(40px) scale(0.97);}
}

#app{height:100dvh;display:flex;flex-direction:column;max-width:480px;margin:0 auto;position:relative;}
.scroll-body{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;}

.topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 18px 12px;flex-shrink:0;background:var(--glass);backdrop-filter:blur(20px) saturate(1.8);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10;transition:background var(--transition);}
.topbar-logo-wrap{display:flex;align-items:center;gap:8px;}
.topbar-logo-icon{width:32px;height:32px;border-radius:10px;background:linear-gradient(135deg,var(--purple),var(--pink));display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:0 2px 8px rgba(139,92,246,0.3);}
.topbar-logo{font-family:'Baloo 2',sans-serif;font-size:20px;font-weight:800;background:linear-gradient(135deg,var(--purple),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.topbar-title{font-size:17px;font-weight:800;color:var(--text);}
.back-btn{width:38px;height:38px;border-radius:var(--r-sm);background:var(--surface);border:1.5px solid var(--border);color:var(--text2);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;transition:all 0.25s var(--smooth);flex-shrink:0;box-shadow:0 2px 8px var(--shadow);}
.back-btn:hover{background:var(--surface2);color:var(--text);transform:scale(1.05);}
.back-btn:active{transform:scale(0.95);}

/* ══════════ BOTTOM NAV - SMOOTHER ══════════ */
.bottom-nav{display:flex;border-top:1px solid var(--border);flex-shrink:0;padding:6px 8px max(10px,env(safe-area-inset-bottom));background:var(--glass);backdrop-filter:blur(20px) saturate(1.8);transition:background var(--transition);}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px 4px;cursor:pointer;transition:all 0.4s var(--smooth);border-radius:var(--r);margin:2px 3px;position:relative;}
.nav-icon{font-size:22px;transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1);}
.nav-label{font-size:10px;font-weight:800;letter-spacing:0.03em;color:var(--text3);transition:all 0.35s var(--smooth);}
.nav-item.active{background:var(--purple-g);}
.nav-item.active .nav-icon{transform:scale(1.2) translateY(-2px);}
.nav-item.active .nav-label{color:var(--purple);font-weight:900;}
.nav-item.active::after{content:'';position:absolute;bottom:2px;left:50%;transform:translateX(-50%);width:20px;height:3px;border-radius:3px;background:linear-gradient(90deg,var(--purple),var(--pink));animation:navDotPop 0.4s cubic-bezier(0.34,1.56,0.64,1) forwards;}
@keyframes navDotPop{0%{width:0;opacity:0;}100%{width:20px;opacity:1;}}

/* ══════════ BUTTONS - SMOOTHER FEEL ══════════ */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 24px;border-radius:var(--r);font-family:'Nunito',sans-serif;font-size:15px;font-weight:800;cursor:pointer;border:none;transition:all 0.3s var(--smooth);white-space:nowrap;will-change:transform;}
.btn-primary{background:linear-gradient(135deg,var(--purple),#a855f7,var(--pink));color:#fff;box-shadow:0 6px 24px rgba(139,92,246,0.35);}
.btn-primary:hover{transform:translateY(-3px);box-shadow:0 10px 36px rgba(139,92,246,0.45);}
.btn-primary:active{transform:translateY(1px) scale(0.98);box-shadow:0 2px 12px rgba(139,92,246,0.3);}
.btn-secondary{background:var(--surface);border:1.5px solid var(--border2);color:var(--text);font-weight:700;box-shadow:0 2px 10px var(--shadow);backdrop-filter:blur(10px);}
.btn-secondary:hover{background:var(--surface2);transform:translateY(-2px);}
.btn-secondary:active{transform:translateY(0) scale(0.98);}
.btn-ghost{background:transparent;color:var(--text2);padding:10px 16px;}
.btn-ghost:hover{color:var(--text);background:var(--surface3);}
.btn-danger{background:var(--red-soft);border:1.5px solid rgba(239,68,68,0.3);color:var(--red);}
.btn-full{width:100%;}
.btn-sm{padding:9px 16px;font-size:13px;}
.btn-xs{padding:6px 12px;font-size:11px;}

/* ══════════ FORM INPUTS ══════════ */
.form-input{width:100%;padding:14px 18px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);color:var(--text);font-family:'Nunito',sans-serif;font-size:15px;font-weight:600;outline:none;transition:all 0.3s var(--smooth);box-shadow:0 2px 8px var(--shadow);backdrop-filter:blur(10px);}
.form-input:focus{border-color:var(--purple);box-shadow:0 0 0 4px rgba(139,92,246,0.12),0 4px 16px var(--shadow);}
.form-input::placeholder{color:var(--text3);}
textarea.form-input{resize:none;line-height:1.7;}
select.form-input{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%239b8ec4' stroke-width='3' stroke-linecap='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 16px center;}

.card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:18px;backdrop-filter:blur(16px) saturate(1.5);box-shadow:0 4px 20px var(--shadow);transition:all 0.3s var(--smooth);}
.pill{padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;background:var(--surface2);border:1px solid var(--border);color:var(--text2);}
.section-label{font-size:11px;font-weight:900;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);margin-bottom:12px;}

/* ══════════ TOAST - SMOOTHER ══════════ */
.toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--surface);border:1.5px solid var(--border2);border-radius:var(--r);padding:14px 22px;font-size:14px;font-weight:700;z-index:9990;opacity:0;transition:all 0.45s var(--smooth);white-space:nowrap;pointer-events:none;max-width:90vw;text-align:center;box-shadow:0 8px 32px var(--shadow2);backdrop-filter:blur(20px);color:var(--text);}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* ══════════ ACHIEVEMENT POPUP - SMOOTHER ══════════ */
.ach-popup{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-120px);background:var(--surface);border:2px solid var(--yellow);border-radius:var(--r-lg);padding:16px 22px;z-index:9991;opacity:0;transition:all 0.6s cubic-bezier(0.34,1.56,0.64,1);display:flex;align-items:center;gap:14px;max-width:340px;box-shadow:0 8px 40px rgba(251,191,36,0.25);backdrop-filter:blur(20px);}
.ach-popup.show{opacity:1;transform:translateX(-50%) translateY(0);}
.ach-pop-icon{font-size:36px;animation:achIconSpin 0.6s cubic-bezier(0.34,1.56,0.64,1);}
@keyframes achIconSpin{from{transform:rotate(-20deg) scale(0.3);opacity:0;}to{transform:rotate(0deg) scale(1);opacity:1;}}
.ach-pop-text h4{font-size:10px;font-weight:900;color:var(--yellow);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:3px;}
.ach-pop-text p{font-size:14px;font-weight:800;color:var(--text);}

/* ══════════ THEME TOGGLE ══════════ */
.theme-toggle{width:44px;height:24px;border-radius:12px;background:var(--surface2);border:1.5px solid var(--border);cursor:pointer;position:relative;transition:all 0.4s var(--smooth);flex-shrink:0;}
.theme-toggle-knob{width:18px;height:18px;border-radius:50%;background:linear-gradient(135deg,var(--yellow),var(--orange));position:absolute;top:2px;left:2px;transition:all 0.45s cubic-bezier(0.34,1.56,0.64,1);display:flex;align-items:center;justify-content:center;font-size:10px;}
[data-theme="dark"] .theme-toggle{background:var(--surface3);}
[data-theme="dark"] .theme-toggle-knob{left:22px;background:linear-gradient(135deg,#6366f1,#8b5cf6);}

/* ══════════ MODAL - SMOOTHER ══════════ */
.modal-overlay{position:fixed;inset:0;z-index:999;background:rgba(0,0,0,0.4);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:all 0.4s var(--smooth);}
.modal-overlay.show{opacity:1;pointer-events:auto;}
.modal-content{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-xl);padding:24px;width:calc(100% - 40px);max-width:400px;backdrop-filter:blur(20px);box-shadow:0 20px 60px var(--shadow2);transform:translateY(40px) scale(0.92);transition:all 0.5s cubic-bezier(0.34,1.56,0.64,1);}
.modal-overlay.show .modal-content{transform:translateY(0) scale(1);}
.modal-title{font-family:'Baloo 2',sans-serif;font-size:22px;font-weight:800;margin-bottom:6px;display:flex;align-items:center;gap:8px;color:var(--text);}
.modal-subtitle{font-size:12px;color:var(--text2);margin-bottom:18px;}
.modal-close{position:absolute;top:16px;right:16px;width:30px;height:30px;border-radius:50%;background:var(--surface2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;color:var(--text3);transition:all 0.25s var(--smooth);}
.modal-close:hover{background:var(--red-soft);color:var(--red);transform:scale(1.1);}

/* Time Picker */
.time-picker-wrap{display:flex;align-items:center;justify-content:center;gap:6px;margin:16px 0;}
.time-col{display:flex;flex-direction:column;align-items:center;gap:4px;}
.time-spin-btn{width:44px;height:34px;border-radius:var(--r-sm);background:var(--surface2);border:1.5px solid var(--border);color:var(--text2);font-size:18px;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.25s var(--smooth);}
.time-spin-btn:hover{background:var(--purple-g);border-color:var(--purple);color:var(--purple);}
.time-spin-btn:active{transform:scale(0.9);}
.time-display{width:56px;height:56px;border-radius:var(--r);background:var(--surface);border:2px solid var(--purple);display:flex;align-items:center;justify-content:center;font-family:'Baloo 2',sans-serif;font-size:28px;font-weight:800;color:var(--purple);box-shadow:0 4px 16px rgba(139,92,246,0.15);transition:all 0.2s var(--smooth);}
.time-sep{font-family:'Baloo 2',sans-serif;font-size:28px;font-weight:800;color:var(--text3);margin:0 2px;padding-top:20px;}
.time-ampm{display:flex;flex-direction:column;gap:4px;margin-left:8px;}
.ampm-btn{padding:6px 14px;border-radius:var(--r-sm);background:var(--surface2);border:1.5px solid var(--border);font-size:12px;font-weight:800;color:var(--text3);cursor:pointer;transition:all 0.3s var(--smooth);}
.ampm-btn.active{background:var(--purple-g);border-color:var(--purple);color:var(--purple);}
.time-presets{display:flex;flex-wrap:wrap;gap:6px;margin-top:12px;justify-content:center;}
.time-preset{padding:6px 14px;border-radius:20px;background:var(--surface2);border:1.5px solid var(--border);font-size:11px;font-weight:700;color:var(--text2);cursor:pointer;transition:all 0.25s var(--smooth);}
.time-preset:hover{border-color:var(--purple);color:var(--purple);background:var(--purple-g);transform:scale(1.05);}

/* ══════════ WELCOME ══════════ */
#screen-welcome{overflow:hidden;position:relative;}
.welcome-content{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:36px 24px;text-align:center;}
.welcome-logo-text{font-family:'Baloo 2',sans-serif;font-size:44px;font-weight:800;background:linear-gradient(135deg,var(--purple-d) 0%,var(--purple) 40%,var(--pink) 70%,var(--orange) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:6px;animation:fadeUp 0.7s var(--smooth) both;}
.welcome-sub{font-size:15px;color:var(--text2);margin-bottom:36px;line-height:1.6;animation:fadeUp 0.7s var(--smooth) 0.1s both;}
.welcome-features{display:flex;flex-direction:column;gap:10px;width:100%;margin-bottom:32px;animation:fadeUp 0.7s var(--smooth) 0.2s both;}
.wf{display:flex;align-items:center;gap:14px;padding:14px 16px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);text-align:left;transition:all 0.3s var(--smooth);backdrop-filter:blur(16px);box-shadow:0 4px 16px var(--shadow);}
.wf:hover{border-color:var(--purple-l);transform:translateX(4px);box-shadow:0 8px 24px var(--shadow2);}
.wf-icon{font-size:28px;flex-shrink:0;}
.wf-text h4{font-size:14px;font-weight:800;margin-bottom:1px;color:var(--text);}
.wf-text p{font-size:12px;color:var(--text2);}
.welcome-cta{width:100%;animation:fadeUp 0.7s var(--smooth) 0.3s both;}
@keyframes fadeUp{from{opacity:0;transform:translateY(24px);}to{opacity:1;transform:translateY(0);}}

/* Setup */
.setup-body{padding:24px 20px;}
.setup-h{font-family:'Baloo 2',sans-serif;font-size:28px;font-weight:700;margin-bottom:6px;color:var(--text);}
.setup-sub{font-size:14px;color:var(--text2);margin-bottom:24px;}
.form-group{margin-bottom:20px;}
.form-label{font-size:12px;font-weight:900;color:var(--text2);margin-bottom:8px;display:block;letter-spacing:0.06em;text-transform:uppercase;}
.avatar-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;}
.av-opt{aspect-ratio:1;background:var(--surface);border:2.5px solid var(--border);border-radius:var(--r);display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer;transition:all 0.35s cubic-bezier(0.34,1.56,0.64,1);box-shadow:0 2px 8px var(--shadow);position:relative;overflow:hidden;}
.av-opt:hover{transform:scale(1.08);border-color:var(--border2);}
.av-opt:active{transform:scale(0.95);}
.av-opt.sel{border-color:var(--purple);background:var(--purple-g);box-shadow:0 4px 16px rgba(139,92,246,0.25);transform:scale(1.1);}
.av-opt.sel::after{content:'\2713';position:absolute;bottom:2px;right:4px;font-size:12px;color:var(--purple);font-weight:900;}
.grade-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.grade-opt{padding:11px 6px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-sm);text-align:center;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.3s var(--smooth);color:var(--text2);box-shadow:0 2px 8px var(--shadow);}
.grade-opt:hover{border-color:var(--border2);color:var(--text);}
.grade-opt:active{transform:scale(0.95);}
.grade-opt.sel{border-color:var(--purple);background:var(--purple-g);color:var(--purple);box-shadow:0 4px 12px rgba(139,92,246,0.2);}

/* ══════════ QUIZ ══════════ */
.quiz-header{padding:14px 18px 12px;flex-shrink:0;}
.quiz-prog-bar{height:10px;background:var(--surface2);border-radius:5px;overflow:hidden;margin-bottom:8px;box-shadow:inset 0 1px 3px var(--shadow);}
.quiz-prog-fill{height:100%;background:linear-gradient(90deg,var(--purple),var(--pink),var(--yellow));border-radius:5px;transition:width 0.6s var(--smooth);}
.quiz-meta{display:flex;justify-content:space-between;font-size:12px;color:var(--text3);font-weight:700;}
.quiz-body{flex:1;overflow-y:auto;padding:20px;}
.quiz-scenario{background:linear-gradient(135deg,var(--purple-g),var(--pink-soft));border:1.5px solid rgba(139,92,246,0.25);border-radius:var(--r-lg);padding:18px;margin-bottom:20px;font-size:13px;line-height:1.7;color:var(--text2);}
.quiz-scenario .scenario-label{font-size:10px;font-weight:900;color:var(--purple);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:6px;}
.quiz-qtext{font-family:'Baloo 2',sans-serif;font-size:20px;font-weight:700;line-height:1.35;margin-bottom:18px;color:var(--text);}
.quiz-opts{display:flex;flex-direction:column;gap:9px;}
.quiz-opt{padding:14px 16px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);cursor:pointer;transition:all 0.3s var(--smooth);display:flex;align-items:center;gap:12px;font-size:13px;font-weight:700;color:var(--text2);box-shadow:0 2px 8px var(--shadow);}
.quiz-opt:hover{border-color:var(--border2);color:var(--text);background:var(--surface2);transform:translateX(4px);box-shadow:0 4px 16px var(--shadow2);}
.quiz-opt:active{transform:translateX(2px) scale(0.99);}
.quiz-opt.sel{border-color:var(--purple);background:var(--purple-g);color:var(--purple);box-shadow:0 4px 16px rgba(139,92,246,0.2);transform:translateX(6px);}
.quiz-dot{width:22px;height:22px;border-radius:50%;border:2px solid var(--border2);flex-shrink:0;transition:all 0.3s var(--smooth);display:flex;align-items:center;justify-content:center;font-size:11px;}
.quiz-opt.sel .quiz-dot{border-color:var(--purple);background:var(--purple);color:#fff;transform:scale(1.1);}
.quiz-footer{padding:10px 18px 14px;flex-shrink:0;border-top:1px solid var(--border);display:flex;gap:10px;background:var(--glass);backdrop-filter:blur(16px);}

/* Results */
.results-hero{padding:28px 20px 0;text-align:center;}
.results-bigicon{font-size:64px;margin-bottom:12px;display:block;animation:pop 0.6s cubic-bezier(0.34,1.56,0.64,1) both;}
.results-h{font-family:'Baloo 2',sans-serif;font-size:30px;font-weight:800;margin-bottom:6px;color:var(--text);}
.results-sub{font-size:13px;color:var(--text2);margin-bottom:20px;}
.results-body{padding:0 18px 20px;}
.result-card{padding:16px;border-radius:var(--r);margin-bottom:10px;display:flex;align-items:center;gap:12px;border:2px solid;cursor:pointer;transition:all 0.3s var(--smooth);position:relative;overflow:hidden;backdrop-filter:blur(10px);box-shadow:0 4px 16px var(--shadow);}
.result-card:hover{transform:translateX(6px);box-shadow:0 8px 24px var(--shadow2);}
.result-rank{font-family:'Baloo 2',sans-serif;font-size:30px;font-weight:800;flex-shrink:0;width:42px;text-align:center;}
.result-info h4{font-size:14px;font-weight:800;margin-bottom:3px;}
.result-info p{font-size:11px;opacity:0.7;line-height:1.4;}
.result-pct-wrap{margin-left:auto;text-align:right;flex-shrink:0;}
.result-pct{font-family:'Baloo 2',sans-serif;font-size:26px;font-weight:800;line-height:1;}
.result-pct-label{font-size:9px;font-weight:700;opacity:0.6;text-transform:uppercase;letter-spacing:0.06em;}
.result-bar-bg{position:absolute;bottom:0;left:0;right:0;height:4px;background:rgba(0,0,0,0.1);}
.result-bar-fill{height:100%;border-radius:0 4px 0 0;transition:width 1.2s var(--smooth);}
@keyframes pop{from{transform:scale(0) rotate(-20deg);opacity:0;}to{transform:scale(1) rotate(0);opacity:1;}}

/* ══════════ HOME ══════════ */
.home-scroll{padding:14px 14px 16px;}
.greeting{margin-bottom:16px;}
.greeting-hi{font-size:13px;color:var(--text2);font-weight:600;}
.greeting-name{font-family:'Baloo 2',sans-serif;font-size:26px;font-weight:800;color:var(--text);}
.xp-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:16px 18px;margin-bottom:14px;display:flex;gap:14px;align-items:center;backdrop-filter:blur(16px);box-shadow:0 4px 20px var(--shadow);transition:all 0.3s var(--smooth);}
.xp-icon{font-size:34px;}.xp-info{flex:1;}
.xp-lbl{font-size:12px;color:var(--text2);font-weight:700;margin-bottom:6px;display:flex;justify-content:space-between;}
.xp-track{height:12px;background:var(--surface3);border-radius:6px;overflow:hidden;box-shadow:inset 0 1px 3px var(--shadow);}
.xp-fill{height:100%;background:linear-gradient(90deg,var(--purple),var(--pink),var(--yellow));border-radius:6px;transition:width 1s var(--smooth);}
.streak-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:14px 16px;margin-bottom:14px;display:flex;gap:12px;align-items:center;backdrop-filter:blur(16px);box-shadow:0 4px 20px var(--shadow);}
.streak-days{display:flex;gap:5px;flex:1;}
.sday{flex:1;aspect-ratio:1;border-radius:10px;background:var(--surface2);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;font-size:9px;font-weight:800;color:var(--text3);transition:all 0.3s var(--smooth);}
.sday.done{background:var(--purple-g);color:var(--purple);}
.sday.today{background:linear-gradient(135deg,var(--purple),var(--pink));color:#fff;box-shadow:0 4px 12px rgba(139,92,246,0.3);}
.sday-dot{width:5px;height:5px;border-radius:50%;background:currentColor;opacity:0.7;}
.streak-stat{text-align:center;}.streak-num{font-family:'Baloo 2',sans-serif;font-size:34px;font-weight:800;color:var(--orange);line-height:1;}.streak-lbl{font-size:9px;font-weight:800;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em;}
.tech-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px;}
.tc{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:16px 14px;cursor:pointer;transition:all 0.35s var(--smooth);position:relative;overflow:hidden;backdrop-filter:blur(16px);box-shadow:0 4px 16px var(--shadow);will-change:transform;}
.tc:hover{transform:translateY(-5px) scale(1.02);box-shadow:0 12px 36px var(--shadow2);}
.tc:active{transform:translateY(-2px) scale(0.99);}
.tc-icon{font-size:32px;margin-bottom:8px;display:block;}.tc-name{font-size:13px;font-weight:800;margin-bottom:3px;color:var(--text);}.tc-desc{font-size:11px;color:var(--text2);line-height:1.4;}
.tc-badge{position:absolute;top:10px;right:10px;font-size:9px;font-weight:900;padding:3px 8px;border-radius:8px;text-transform:uppercase;letter-spacing:0.04em;}
.tc-best{background:var(--yellow-soft);color:var(--orange);border:1px solid rgba(251,191,36,0.4);}.tc-match{background:var(--surface3);color:var(--text3);border:1px solid var(--border);}
.tip-card{background:linear-gradient(135deg,var(--purple-g),var(--pink-soft));border:1.5px solid rgba(139,92,246,0.2);border-radius:var(--r-lg);padding:16px 18px;margin-bottom:16px;backdrop-filter:blur(10px);box-shadow:0 4px 16px var(--shadow);}
.tip-card p{font-size:13px;color:var(--text2);line-height:1.7;}

/* Study List */
.tech-list-item{display:flex;align-items:center;gap:14px;padding:16px 18px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);cursor:pointer;transition:all 0.3s var(--smooth);margin-bottom:10px;backdrop-filter:blur(16px);box-shadow:0 4px 16px var(--shadow);}
.tech-list-item:hover{border-color:var(--purple-l);background:var(--surface2);transform:translateX(6px);box-shadow:0 8px 24px var(--shadow2);}
.tech-list-item:active{transform:translateX(3px) scale(0.99);}
.tli-icon{font-size:34px;flex-shrink:0;}.tli-info{flex:1;}.tli-name{font-size:15px;font-weight:800;margin-bottom:3px;color:var(--text);}.tli-desc{font-size:12px;color:var(--text2);}
.tli-match{margin-top:6px;display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:10px;font-size:10px;font-weight:800;}

/* ══════════ FLASHCARDS ══════════ */
.fc-tabs{display:flex;gap:0;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--glass);backdrop-filter:blur(16px);}
.fc-tab{flex:1;padding:12px 8px;text-align:center;font-size:12px;font-weight:800;color:var(--text3);cursor:pointer;transition:all 0.35s var(--smooth);border-bottom:3px solid transparent;letter-spacing:0.03em;}
.fc-tab.active{color:var(--purple);border-bottom-color:var(--purple);}
.fc-section{display:none;padding:16px;flex:1;overflow-y:auto;}
.fc-section.active{display:block;animation:sectionFade 0.4s var(--smooth) forwards;}
@keyframes sectionFade{0%{opacity:0;transform:translateY(10px);}100%{opacity:1;transform:translateY(0);}}

.deck-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);padding:14px 16px;margin-bottom:10px;cursor:pointer;transition:all 0.3s var(--smooth);display:flex;align-items:center;gap:12px;backdrop-filter:blur(16px);box-shadow:0 4px 16px var(--shadow);}
.deck-card:hover{border-color:var(--purple-l);transform:translateX(4px);box-shadow:0 8px 24px var(--shadow2);}
.deck-dot{width:14px;height:14px;border-radius:6px;flex-shrink:0;}.deck-info h4{font-size:15px;font-weight:800;margin-bottom:2px;color:var(--text);}.deck-info p{font-size:11px;color:var(--text2);}.deck-count{margin-left:auto;font-size:13px;font-weight:800;color:var(--text3);}
.create-deck-form{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:18px;margin-bottom:14px;backdrop-filter:blur(16px);box-shadow:0 4px 16px var(--shadow);}
.create-deck-form h4{font-size:14px;font-weight:800;margin-bottom:12px;display:flex;align-items:center;gap:8px;color:var(--text);}
.color-picker{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}
.color-swatch{width:30px;height:30px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:all 0.35s cubic-bezier(0.34,1.56,0.64,1);box-shadow:0 2px 8px var(--shadow);}
.color-swatch:active{transform:scale(0.9);}
.color-swatch.sel{border-color:#fff;transform:scale(1.25);box-shadow:0 4px 16px var(--shadow2);}
.fc-scene{perspective:1000px;height:220px;cursor:pointer;margin-bottom:16px;}
.fc-inner{width:100%;height:100%;position:relative;transform-style:preserve-3d;transition:transform 0.7s var(--smooth);will-change:transform;}
.fc-inner.flipped{transform:rotateY(180deg);}
.fc-face{position:absolute;inset:0;backface-visibility:hidden;-webkit-backface-visibility:hidden;background:var(--surface);border:2px solid var(--border);border-radius:var(--r-lg);display:flex;align-items:center;justify-content:center;padding:20px;flex-direction:column;gap:8px;backdrop-filter:blur(16px);box-shadow:0 8px 32px var(--shadow);}
.fc-back-face{transform:rotateY(180deg);background:linear-gradient(135deg,var(--surface),var(--surface2));}
.fc-face-label{font-size:10px;font-weight:900;color:var(--text3);letter-spacing:0.12em;text-transform:uppercase;}.fc-face-text{font-size:18px;font-weight:800;text-align:center;line-height:1.4;color:var(--text);}.fc-face-hint{font-size:11px;color:var(--text3);margin-top:4px;}
.fc-rate-btns{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px;}
.fc-rate{padding:12px 6px;border-radius:var(--r-sm);font-size:12px;font-weight:800;cursor:pointer;border:1.5px solid;transition:all 0.25s var(--smooth);text-align:center;box-shadow:0 2px 8px var(--shadow);}
.fc-again{background:var(--red-soft);border-color:rgba(239,68,68,0.3);color:var(--red);}.fc-hard{background:var(--orange-soft);border-color:rgba(249,115,22,0.3);color:var(--orange);}.fc-good{background:var(--green-soft);border-color:rgba(16,185,129,0.3);color:var(--green);}
.fc-rate:hover{transform:translateY(-3px);box-shadow:0 6px 16px var(--shadow2);}
.fc-rate:active{transform:translateY(0) scale(0.97);}

.ai-gen-box{background:linear-gradient(135deg,var(--purple-g),var(--pink-soft));border:1.5px solid rgba(139,92,246,0.25);border-radius:var(--r-lg);padding:18px;margin-bottom:14px;backdrop-filter:blur(10px);box-shadow:0 4px 16px var(--shadow);}
.ai-gen-box h4{font-size:14px;font-weight:800;margin-bottom:4px;display:flex;align-items:center;gap:6px;color:var(--text);}.ai-gen-box p{font-size:12px;color:var(--text2);margin-bottom:12px;line-height:1.5;}
.upload-area{border:2px dashed var(--border2);border-radius:var(--r);padding:22px;text-align:center;cursor:pointer;transition:all 0.3s var(--smooth);background:var(--surface);margin-bottom:10px;box-shadow:0 2px 8px var(--shadow);}
.upload-area:hover{border-color:var(--purple);background:var(--purple-g);transform:scale(1.01);}
.upload-area.drag{border-color:var(--purple);background:var(--purple-g);transform:scale(1.02);}
.upload-icon{font-size:36px;margin-bottom:8px;display:block;}.upload-text{font-size:13px;font-weight:700;color:var(--text2);margin-bottom:4px;}.upload-hint{font-size:11px;color:var(--text3);}
.upload-status{padding:12px 16px;border-radius:var(--r-sm);margin-bottom:10px;font-size:12px;font-weight:700;display:flex;align-items:center;gap:8px;}
.upload-loading{background:var(--blue-soft);color:var(--blue);border:1px solid rgba(59,130,246,0.3);}.upload-success{background:var(--green-soft);color:var(--green);border:1px solid rgba(16,185,129,0.3);}
.spinner{width:20px;height:20px;border:2.5px solid var(--border);border-top-color:var(--purple);border-radius:50%;animation:spin 0.8s linear infinite;display:inline-block;}
@keyframes spin{to{transform:rotate(360deg);}}

/* Whiteboard */
#screen-whiteboard{background:var(--bg);}
.wb-topbar{display:flex;align-items:center;gap:8px;padding:10px 14px;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--glass);backdrop-filter:blur(16px);flex-wrap:wrap;}
.wb-colors{display:flex;gap:6px;align-items:center;}.wb-color{width:24px;height:24px;border-radius:50%;cursor:pointer;border:2.5px solid transparent;transition:all 0.35s cubic-bezier(0.34,1.56,0.64,1);flex-shrink:0;box-shadow:0 2px 6px var(--shadow);}.wb-color.sel{border-color:#fff;transform:scale(1.3);box-shadow:0 4px 12px var(--shadow2);}
.wb-sizes{display:flex;gap:4px;}.wb-sz{width:32px;height:32px;border-radius:10px;background:var(--surface);border:1.5px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.25s var(--smooth);color:var(--text2);font-size:11px;font-weight:800;}.wb-sz.sel{border-color:var(--purple);color:var(--purple);background:var(--purple-g);}
.wb-tools{display:flex;gap:4px;}.wb-tool{padding:7px 12px;border-radius:10px;background:var(--surface);border:1.5px solid var(--border);cursor:pointer;font-size:12px;font-weight:700;color:var(--text2);transition:all 0.25s var(--smooth);}.wb-tool:hover{border-color:var(--border2);color:var(--text);}.wb-tool.sel{border-color:var(--purple);background:var(--purple-g);color:var(--purple);}
.wb-canvas-wrap{flex:1;position:relative;overflow:hidden;}
#wbCanvas{display:block;width:100%;height:100%;touch-action:none;}

/* Diagram */
.diag-toolbar{display:flex;align-items:center;gap:8px;padding:10px 14px;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--glass);backdrop-filter:blur(16px);overflow-x:auto;}.diag-toolbar::-webkit-scrollbar{display:none;}
.diag-color{width:22px;height:22px;border-radius:50%;cursor:pointer;border:2.5px solid transparent;flex-shrink:0;transition:all 0.35s cubic-bezier(0.34,1.56,0.64,1);}.diag-color.sel{border-color:#fff;transform:scale(1.3);}
.diag-add-input{flex:1;min-width:100px;padding:8px 14px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-sm);color:var(--text);font-family:'Nunito',sans-serif;font-size:13px;font-weight:700;outline:none;transition:border-color 0.25s;}.diag-add-input:focus{border-color:var(--purple);}
.diag-canvas-wrap{flex:1;position:relative;overflow:hidden;background:var(--surface3);}
#diagCanvas{position:absolute;inset:0;width:100%;height:100%;pointer-events:none;}.diag-nodes-layer{position:absolute;inset:0;}
.diag-node{position:absolute;padding:10px 16px;border-radius:var(--r-sm);font-size:13px;font-weight:800;cursor:move;border:2px solid;transition:box-shadow 0.25s var(--smooth);white-space:normal;text-align:center;touch-action:none;box-shadow:0 4px 16px var(--shadow);max-width:200px;word-break:break-word;backdrop-filter:blur(10px);}.diag-node:hover{box-shadow:0 8px 28px var(--shadow2);}.diag-node.root{border-width:3px;font-size:14px;}
.diag-node-del{position:absolute;top:-8px;right:-8px;width:20px;height:20px;border-radius:50%;background:var(--red);color:#fff;font-size:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;opacity:0;transition:opacity 0.2s;}.diag-node:hover .diag-node-del{opacity:1;}
.diag-bottom-bar{padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:8px;flex-shrink:0;background:var(--glass);backdrop-filter:blur(16px);}

/* Schedule */
.sched-week{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-bottom:16px;}
.sched-day{aspect-ratio:0.9;border-radius:var(--r-sm);background:var(--surface);border:1.5px solid var(--border);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all 0.25s var(--smooth);gap:2px;box-shadow:0 2px 8px var(--shadow);}
.sched-dlbl{font-size:8px;font-weight:900;color:var(--text3);text-transform:uppercase;}.sched-dnum{font-size:13px;font-weight:800;color:var(--text2);}
.sched-day.has{border-color:var(--purple);background:var(--purple-g);}.sched-day.has .sched-dnum{color:var(--purple);}
.sched-day.rest{border-color:var(--teal);background:var(--teal-soft);}.sched-day.rest .sched-dnum{color:var(--teal);}
.sched-day.today{border-color:var(--orange);box-shadow:0 4px 16px rgba(249,115,22,0.2);}.sched-day.today .sched-dnum{color:var(--orange);}
.sess-item{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);margin-bottom:8px;backdrop-filter:blur(16px);box-shadow:0 2px 10px var(--shadow);transition:all 0.25s var(--smooth);}.sess-item:hover{transform:translateX(3px);}
.sess-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0;}.sess-info h4{font-size:14px;font-weight:800;margin-bottom:2px;color:var(--text);}.sess-info p{font-size:11px;color:var(--text2);}.sess-time{margin-left:auto;font-size:12px;font-weight:800;color:var(--text3);}
.timer-wrap{text-align:center;padding:20px 0;}
.timer-ring{width:170px;height:170px;border-radius:50%;background:var(--surface);border:4px solid var(--border);margin:0 auto 14px;display:flex;align-items:center;justify-content:center;font-family:'Baloo 2',sans-serif;font-size:42px;font-weight:800;color:var(--purple);box-shadow:0 8px 40px var(--shadow);position:relative;transition:all 0.4s var(--smooth);}
.timer-ring.focus-mode{border-color:var(--purple);box-shadow:0 8px 48px rgba(139,92,246,0.3);}.timer-ring.break-mode{border-color:var(--green);box-shadow:0 8px 48px rgba(16,185,129,0.2);}
.timer-phase{font-size:14px;color:var(--text2);font-weight:700;margin-bottom:14px;}

/* Achievements */
.ach-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
.ach-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:16px 14px;text-align:center;transition:all 0.3s var(--smooth);position:relative;overflow:hidden;backdrop-filter:blur(16px);box-shadow:0 4px 16px var(--shadow);}.ach-card.unlocked:hover{transform:translateY(-4px);box-shadow:0 12px 32px var(--shadow2);}.ach-card.locked{opacity:0.35;}
.ach-icon{font-size:36px;display:block;margin-bottom:8px;}.ach-name{font-size:13px;font-weight:800;margin-bottom:4px;line-height:1.3;color:var(--text);}.ach-desc{font-size:10px;color:var(--text2);line-height:1.4;margin-bottom:8px;}
.ach-rarity{font-size:9px;font-weight:900;padding:3px 10px;border-radius:12px;text-transform:uppercase;letter-spacing:0.06em;display:inline-block;}
.r-common{background:var(--green-soft);color:var(--green);}.r-rare{background:var(--blue-soft);color:var(--blue);}.r-epic{background:rgba(167,139,250,0.15);color:#8b5cf6;}.r-legendary{background:var(--yellow-soft);color:var(--orange);}
.ach-new{position:absolute;top:8px;right:8px;font-size:9px;font-weight:900;padding:2px 8px;border-radius:8px;background:var(--yellow);color:#000;text-transform:uppercase;}

/* Tech Bodies */
.tech-body{padding:14px;flex:1;overflow-y:auto;}
.blurt-timer-big{font-family:'Baloo 2',sans-serif;font-size:52px;font-weight:800;color:var(--purple);text-align:center;margin:8px 0 12px;}
.phase-badge{display:inline-flex;align-items:center;gap:6px;padding:7px 16px;border-radius:20px;font-size:12px;font-weight:800;margin-bottom:12px;}
.compare-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;}
.compare-box{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);padding:12px;font-size:12px;line-height:1.6;color:var(--text2);min-height:90px;box-shadow:0 2px 8px var(--shadow);}.compare-box h5{font-size:10px;font-weight:900;color:var(--text3);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.06em;}
.feynman-steps{display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:16px;background:var(--glass);backdrop-filter:blur(10px);}
.feynman-step{flex:1;padding:10px 6px;text-align:center;font-size:10px;font-weight:800;color:var(--text3);border-bottom:3px solid transparent;cursor:pointer;transition:all 0.35s var(--smooth);letter-spacing:0.04em;text-transform:uppercase;}.feynman-step.active{color:var(--purple);border-bottom-color:var(--purple);}
.cornell-grid{display:grid;grid-template-columns:1fr 2fr;gap:10px;margin-bottom:10px;}
.cornell-lbl{font-size:10px;font-weight:900;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px;}
.rrr-btns{display:flex;gap:8px;margin-bottom:14px;}
.rrr-btn{flex:1;padding:12px 6px;border-radius:var(--r-sm);font-size:12px;font-weight:800;text-align:center;border:1.5px solid var(--border);background:var(--surface);cursor:pointer;color:var(--text2);transition:all 0.3s var(--smooth);box-shadow:0 2px 8px var(--shadow);}.rrr-btn.active{background:var(--purple-g);border-color:var(--purple);color:var(--purple);}
</style>
</head>
<body>

<div class="app-bg"><div class="bg-orb bg-orb-1"></div><div class="bg-orb bg-orb-2"></div><div class="bg-orb bg-orb-3"></div><div class="bg-orb bg-orb-4"></div></div>

<!-- ══════════ EPIC SPLASH SCREEN ══════════ -->
<div id="splash">
  <div class="splash-bg"></div>
  <div class="splash-particles" id="splash-particles"></div>
  <div class="splash-rings">
    <div class="splash-ring"></div>
    <div class="splash-ring"></div>
    <div class="splash-ring"></div>
    <div class="splash-ring"></div>
  </div>
  <div class="splash-logo-wrap">
    <div class="logo-mark">
      <div class="logo-ring"></div>
      <div class="logo-brain">🧠</div>
      <div class="logo-book"></div>
      <div class="logo-sparkle logo-sparkle-1">✨</div>
      <div class="logo-sparkle logo-sparkle-2">⭐</div>
      <div class="logo-sparkle logo-sparkle-3">💡</div>
    </div>
    <div class="splash-title">StudyBuddy</div>
    <div class="splash-tagline">Your personal study companion.<br>Learn smarter, not harder.</div>
  </div>
  <div class="splash-loader"><div class="splash-loader-fill"></div></div>
  <div class="splash-ready">Preparing your workspace...</div>
</div>

<div id="app">

  <div class="screen" id="screen-welcome">
    <div class="welcome-content">
      <div class="logo-mark" style="margin-bottom:10px;transform:scale(0.8);animation:fadeUp 0.5s ease both;">
        <div class="logo-ring" style="animation:logoRingSpin 3s linear infinite;opacity:1;"></div>
        <div class="logo-brain" style="opacity:1;animation:brainBounce 2s ease-in-out infinite;">🧠</div>
        <div class="logo-book"></div>
        <div class="logo-sparkle logo-sparkle-1" style="opacity:1;animation:sparkleFloat 2s ease-in-out infinite;">✨</div>
        <div class="logo-sparkle logo-sparkle-2" style="opacity:1;animation:sparkleFloat 2s ease-in-out 0.5s infinite;">⭐</div>
        <div class="logo-sparkle logo-sparkle-3" style="opacity:1;animation:sparkleFloat 2s ease-in-out 1s infinite;">💡</div>
      </div>
      <div class="welcome-logo-text">StudyBuddy</div>
      <div class="welcome-sub">Your personal study companion.<br>Learn smarter, not harder.</div>
      <div class="welcome-features">
        <div class="wf"><span class="wf-icon">🧠</span><div class="wf-text"><h4>Scenario-Based Assessment</h4><p>Find your best study style through real situations</p></div></div>
        <div class="wf"><span class="wf-icon">🃏</span><div class="wf-text"><h4>7 Built-in Study Workrooms</h4><p>Flashcards, Feynman, diagrams and more</p></div></div>
        <div class="wf"><span class="wf-icon">🏆</span><div class="wf-text"><h4>Achievements and Streaks</h4><p>Earn rewards as you grow smarter</p></div></div>
      </div>
      <div class="welcome-cta">
        <button class="btn btn-primary btn-full" onclick="SFX.tap();navigateTo('screen-setup')" style="font-size:16px;padding:16px;">Get Started</button>
        <div style="margin-top:10px;"><button class="btn btn-ghost btn-full" onclick="SFX.tap();loadExisting()">I already have a profile</button></div>
      </div>
    </div>
  </div>

  <div class="screen" id="screen-setup">
    <div class="topbar"><div class="topbar-logo-wrap"><div class="topbar-logo-icon">📚</div><div class="topbar-logo">StudyBuddy</div></div><span style="font-size:12px;color:var(--text3);font-weight:700;">Step 1 of 2</span></div>
    <div class="scroll-body"><div class="setup-body">
      <div class="setup-h">Create your profile</div>
      <div class="setup-sub">Everything stays on your device.</div>
      <div class="form-group"><label class="form-label">Your Name</label><input class="form-input" id="inp-name" type="text" placeholder="e.g. Maria Santos" maxlength="30"></div>
      <div class="form-group"><label class="form-label">Pick an Avatar</label><div class="avatar-grid" id="av-grid"></div></div>
      <div class="form-group"><label class="form-label">Grade Level</label><div class="grade-grid" id="gr-grid"></div></div>
      <button class="btn btn-primary btn-full" onclick="SFX.tap();saveProfile()" style="margin-top:8px;">Next: Take the Assessment</button>
    </div></div>
  </div>

  <div class="screen" id="screen-quiz">
    <div class="quiz-header">
      <div style="display:flex;align-items:center;margin-bottom:10px;"><div class="topbar-logo-wrap"><div class="topbar-logo-icon">📚</div><div class="topbar-logo" style="font-size:16px;">StudyBuddy</div></div><span style="font-size:12px;color:var(--text3);font-weight:700;margin-left:auto;">Assessment</span></div>
      <div class="quiz-prog-bar"><div class="quiz-prog-fill" id="q-prog" style="width:2%"></div></div>
      <div class="quiz-meta"><span id="q-num">Q1 / 50</span><span id="q-hint" style="color:var(--purple);">Results at Q50</span></div>
    </div>
    <div class="quiz-body" id="q-body"></div>
    <div class="quiz-footer">
      <button class="btn btn-secondary" onclick="SFX.tap();qPrev()" id="q-prev" style="width:80px;">Back</button>
      <button class="btn btn-primary" onclick="SFX.tap();qNext()" id="q-next" style="flex:1;">Next</button>
    </div>
  </div>

  <div class="screen" id="screen-results">
    <div class="scroll-body">
      <div class="results-hero"><span class="results-bigicon">🎉</span><div class="results-h">Your Results Are In!</div><div class="results-sub" id="r-sub">Here is how your learning styles ranked</div></div>
      <div class="results-body" id="r-body"></div>
      <div style="padding:0 18px 24px;"><button class="btn btn-primary btn-full" onclick="SFX.success();goToHome()">Start Learning</button></div>
    </div>
  </div>

  <div class="screen" id="screen-home">
    <div class="topbar">
      <div class="topbar-logo-wrap"><div class="topbar-logo-icon">📚</div><div class="topbar-logo">StudyBuddy</div></div>
      <div style="display:flex;align-items:center;gap:10px;">
        <div class="theme-toggle" onclick="toggleTheme()"><div class="theme-toggle-knob" id="theme-knob">☀️</div></div>
        <span id="home-av" style="font-size:24px;">🦊</span>
      </div>
    </div>
    <div class="scroll-body home-scroll" id="home-body">
      <div class="greeting"><div class="greeting-hi" id="greeting-time">Welcome back,</div><div class="greeting-name" id="g-name">Learner!</div></div>
      <div class="xp-card"><span class="xp-icon">⚡</span><div class="xp-info"><div class="xp-lbl"><span>Level <span id="xp-lv">1</span></span><span><span id="xp-cur">0</span>/<span id="xp-nxt">200</span> XP</span></div><div class="xp-track"><div class="xp-fill" id="xp-bar" style="width:0%"></div></div></div></div>
      <div class="streak-card"><div class="streak-days" id="streak-days"></div><div class="streak-stat"><div class="streak-num" id="streak-n">0</div><div class="streak-lbl">Streak</div></div></div>
      <div class="section-label">Recommended Techniques</div>
      <div class="tech-grid" id="home-tech-grid"></div>
      <div class="section-label">Quick Actions</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;">
        <button class="btn btn-secondary" onclick="SFX.tap();switchNav('schedule')">Schedule</button>
        <button class="btn btn-secondary" onclick="SFX.tap();switchNav('achievements')">Awards</button>
      </div>
      <div class="section-label">Daily Tip</div>
      <div class="tip-card" id="daily-tip"><p></p></div>
    </div>
    <div class="bottom-nav" id="home-nav">
      <div class="nav-item active" onclick="SFX.tap();switchNav('home')"><span class="nav-icon">🏠</span><span class="nav-label">Home</span></div>
      <div class="nav-item" onclick="SFX.tap();switchNav('study')"><span class="nav-icon">📚</span><span class="nav-label">Study</span></div>
      <div class="nav-item" onclick="SFX.tap();switchNav('schedule')"><span class="nav-icon">📅</span><span class="nav-label">Schedule</span></div>
      <div class="nav-item" onclick="SFX.tap();switchNav('achievements')"><span class="nav-icon">🏆</span><span class="nav-label">Awards</span></div>
    </div>
  </div>

  <div class="screen" id="screen-study">
    <div class="topbar"><div class="topbar-title">Study Tools</div></div>
    <div class="scroll-body" style="padding:14px;" id="study-list-body"></div>
    <div class="bottom-nav"><div class="nav-item" onclick="SFX.tap();switchNav('home')"><span class="nav-icon">🏠</span><span class="nav-label">Home</span></div><div class="nav-item active" onclick="SFX.tap();switchNav('study')"><span class="nav-icon">📚</span><span class="nav-label">Study</span></div><div class="nav-item" onclick="SFX.tap();switchNav('schedule')"><span class="nav-icon">📅</span><span class="nav-label">Schedule</span></div><div class="nav-item" onclick="SFX.tap();switchNav('achievements')"><span class="nav-icon">🏆</span><span class="nav-label">Awards</span></div></div>
  </div>

  <div class="screen" id="screen-schedule">
    <div class="topbar"><div class="topbar-title">My Schedule</div><button class="btn btn-sm btn-primary" onclick="SFX.tap();showAddSessionModal()">+ Add</button></div>
    <div class="scroll-body" style="padding:14px;" id="sched-body">
      <div class="section-label">This Week</div><div class="sched-week" id="sched-week"></div>
      <div class="section-label" style="margin-top:14px;">Sessions</div><div id="sess-list"></div>
      <div style="margin-top:10px;"><button class="btn btn-secondary btn-full" onclick="SFX.tap();toggleRest()">Toggle Rest Day Today</button></div>
      <div class="section-label" style="margin-top:20px;">Pomodoro Timer</div>
      <div class="timer-wrap"><div class="timer-ring" id="timer-ring">25:00</div><div class="timer-phase" id="timer-phase">Focus Session</div><div style="display:flex;gap:10px;justify-content:center;"><button class="btn btn-primary" onclick="SFX.tap();toggleTimer()" id="timer-btn">Start</button><button class="btn btn-secondary" onclick="SFX.tap();resetTimer()">Reset</button></div></div>
    </div>
    <div class="bottom-nav"><div class="nav-item" onclick="SFX.tap();switchNav('home')"><span class="nav-icon">🏠</span><span class="nav-label">Home</span></div><div class="nav-item" onclick="SFX.tap();switchNav('study')"><span class="nav-icon">📚</span><span class="nav-label">Study</span></div><div class="nav-item active" onclick="SFX.tap();switchNav('schedule')"><span class="nav-icon">📅</span><span class="nav-label">Schedule</span></div><div class="nav-item" onclick="SFX.tap();switchNav('achievements')"><span class="nav-icon">🏆</span><span class="nav-label">Awards</span></div></div>
  </div>

  <div class="screen" id="screen-achievements">
    <div class="topbar"><div class="topbar-title">Achievements</div><span style="font-size:12px;color:var(--text2);font-weight:700;" id="ach-count">0/18</span></div>
    <div class="scroll-body" style="padding:14px;"><div class="ach-grid" id="ach-grid"></div></div>
    <div class="bottom-nav"><div class="nav-item" onclick="SFX.tap();switchNav('home')"><span class="nav-icon">🏠</span><span class="nav-label">Home</span></div><div class="nav-item" onclick="SFX.tap();switchNav('study')"><span class="nav-icon">📚</span><span class="nav-label">Study</span></div><div class="nav-item" onclick="SFX.tap();switchNav('schedule')"><span class="nav-icon">📅</span><span class="nav-label">Schedule</span></div><div class="nav-item active" onclick="SFX.tap();switchNav('achievements')"><span class="nav-icon">🏆</span><span class="nav-label">Awards</span></div></div>
  </div>

  <div class="screen" id="screen-flashcards">
    <div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Flashcards</div></div>
    <div class="fc-tabs"><div class="fc-tab active" onclick="switchFcTab('decks',this)">Decks</div><div class="fc-tab" onclick="switchFcTab('create',this)">Create</div><div class="fc-tab" onclick="switchFcTab('ai',this)">AI Gen</div></div>
    <div class="fc-section active" id="fc-decks"></div><div class="fc-section" id="fc-create"></div><div class="fc-section" id="fc-ai"></div><div class="fc-section" id="fc-study"></div>
  </div>

  <div class="screen" id="screen-blurting"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Blurting</div></div><div class="scroll-body tech-body" id="blurt-body"></div></div>
  <div class="screen" id="screen-question"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Question Method</div></div><div class="scroll-body tech-body" id="cornell-body"></div></div>
  <div class="screen" id="screen-feynman"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Feynman Technique</div></div><div class="scroll-body tech-body" id="feynman-body"></div></div>
  <div class="screen" id="screen-rrr"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Read, Recite, Review</div></div><div class="scroll-body tech-body" id="rrr-body"></div></div>
  <div class="screen" id="screen-whiteboard"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Brain Dump</div></div><div class="wb-topbar" id="wb-toolbar"></div><div class="wb-canvas-wrap"><canvas id="wbCanvas"></canvas></div><div style="padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:8px;flex-shrink:0;background:var(--glass);backdrop-filter:blur(16px);"><button class="btn btn-secondary btn-sm" onclick="SFX.tap();wbClear()">Clear</button><button class="btn btn-primary btn-sm" style="flex:1;" onclick="SFX.tap();wbSave()">Save Session</button></div></div>
  <div class="screen" id="screen-diagram"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Active Diagramming</div></div><div class="diag-toolbar" id="diag-toolbar"></div><div class="diag-canvas-wrap" id="diag-wrap"><canvas id="diagCanvas"></canvas><div class="diag-nodes-layer" id="diag-nodes"></div></div><div class="diag-bottom-bar"><button class="btn btn-danger btn-sm" onclick="SFX.tap();diagClear()">Clear</button><button class="btn btn-secondary btn-sm" onclick="SFX.tap();diagConnect()">Connect</button><button class="btn btn-primary btn-sm" style="flex:1;" onclick="SFX.tap();diagSave()">Save</button></div></div>

  <div class="modal-overlay" id="session-modal">
    <div class="modal-content" style="position:relative;">
      <div class="modal-close" onclick="hideAddSessionModal()">x</div>
      <div class="modal-title">New Study Session</div>
      <div class="modal-subtitle">Plan your next study session</div>
      <div class="form-group"><label class="form-label">Subject</label><input class="form-input" id="modal-subject" placeholder="e.g. Biology Chapter 5"></div>
      <div class="form-group"><label class="form-label">Technique</label><select class="form-input" id="modal-technique"><option value="flashcards">Flashcards</option><option value="blurting">Blurting</option><option value="question">Question Method</option><option value="feynman">Feynman Technique</option><option value="rrr">Read, Recite, Review</option><option value="whiteboard">Brain Dump</option><option value="diagram">Active Diagramming</option></select></div>
      <div class="form-group"><label class="form-label">Duration (minutes)</label><input class="form-input" id="modal-duration" type="number" value="30" min="5" max="180"></div>
      <div class="form-group"><label class="form-label">Time</label><div style="text-align:center;cursor:pointer;padding:10px;background:var(--surface2);border:1.5px solid var(--border);border-radius:var(--r);font-weight:800;color:var(--purple);" onclick="showTimePicker()" id="modal-time-display">2:00 PM - Tap to change</div></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px;"><button class="btn btn-secondary" onclick="hideAddSessionModal()">Cancel</button><button class="btn btn-primary" onclick="SFX.correct();confirmAddSession()">Add Session</button></div>
    </div>
  </div>

  <div class="modal-overlay" id="time-modal">
    <div class="modal-content" style="position:relative;">
      <div class="modal-close" onclick="hideTimePicker()">x</div>
      <div class="modal-title">Set Time</div>
      <div class="modal-subtitle">Pick when you want to study</div>
      <div class="time-picker-wrap"><div class="time-col"><div class="time-spin-btn" onclick="spinTime('h',1)">&#9650;</div><div class="time-display" id="tp-hour">02</div><div class="time-spin-btn" onclick="spinTime('h',-1)">&#9660;</div></div><div class="time-sep">:</div><div class="time-col"><div class="time-spin-btn" onclick="spinTime('m',1)">&#9650;</div><div class="time-display" id="tp-min">00</div><div class="time-spin-btn" onclick="spinTime('m',-1)">&#9660;</div></div><div class="time-ampm"><div class="ampm-btn active" id="tp-pm-am" onclick="setAMPM('AM')">AM</div><div class="ampm-btn" id="tp-pm-pm" onclick="setAMPM('PM')">PM</div></div></div>
      <div class="time-presets" id="time-presets"></div>
      <button class="btn btn-primary btn-full" style="margin-top:16px;" onclick="confirmTimePick()">Confirm Time</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>
  <div class="ach-popup" id="ach-popup"><span class="ach-pop-icon" id="ap-icon">🏆</span><div class="ach-pop-text"><h4>Achievement Unlocked!</h4><p id="ap-name"></p></div></div>
</div>

<script>
// ══════════ GENERATE SPLASH PARTICLES ══════════
(function(){
  var pc=document.getElementById('splash-particles');
  for(var i=0;i<20;i++){
    var p=document.createElement('div');
    p.className='splash-particle';
    var sz=4+Math.random()*12;
    p.style.width=sz+'px';
    p.style.height=sz+'px';
    p.style.left=Math.random()*100+'%';
    p.style.animationDuration=(4+Math.random()*6)+'s';
    p.style.animationDelay=Math.random()*4+'s';
    pc.appendChild(p);
  }
})();

// ══════════ SOUND ENGINE ══════════
var SFX=(function(){var ctx=null;function getCtx(){if(!ctx){try{ctx=new(window.AudioContext||window.webkitAudioContext)();}catch(e){}}return ctx;}function play(f,t,d,v){var c=getCtx();if(!c)return;try{var o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.type=t||'sine';o.frequency.value=f;g.gain.setValueAtTime(v||0.12,c.currentTime);g.gain.exponentialRampToValueAtTime(0.001,c.currentTime+(d||0.12));o.start(c.currentTime);o.stop(c.currentTime+(d||0.12)+0.1);}catch(e){}}function chord(f,t,d){f.forEach(function(x,i){setTimeout(function(){play(x,t,d,0.1);},i*50);});}return{tap:function(){play(520,'triangle',0.06,0.08);},select:function(){play(523,'sine',0.08,0.1);setTimeout(function(){play(659,'sine',0.08,0.08);},60);},correct:function(){chord([523,659,784],'sine',0.15);},success:function(){chord([523,659,784,1047],'sine',0.25);},flip:function(){play(660,'triangle',0.05,0.07);setTimeout(function(){play(880,'triangle',0.04,0.05);},50);},unlock:function(){play(784,'sine',0.12,0.12);setTimeout(function(){play(1047,'sine',0.15,0.15);},120);setTimeout(function(){play(1319,'sine',0.2,0.18);},250);},error:function(){play(200,'sawtooth',0.1,0.08);setTimeout(function(){play(180,'sawtooth',0.1,0.06);},80);},whoosh:function(){var c=getCtx();if(!c)return;try{var o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.type='sine';o.frequency.setValueAtTime(900,c.currentTime);o.frequency.exponentialRampToValueAtTime(200,c.currentTime+0.25);g.gain.setValueAtTime(0.08,c.currentTime);g.gain.exponentialRampToValueAtTime(0.001,c.currentTime+0.25);o.start();o.stop(c.currentTime+0.25);}catch(e){}},timer:function(){chord([880,1108,1320],'sine',0.25);},navigate:function(){play(440,'triangle',0.06,0.06);setTimeout(function(){play(554,'triangle',0.06,0.05);},40);},pop:function(){play(880,'sine',0.04,0.06);},erase:function(){play(300,'triangle',0.08,0.05);},startup:function(){setTimeout(function(){play(392,'sine',0.15,0.08);},0);setTimeout(function(){play(523,'sine',0.15,0.08);},150);setTimeout(function(){play(659,'sine',0.15,0.08);},300);setTimeout(function(){play(784,'sine',0.2,0.1);},450);setTimeout(function(){chord([784,988,1175],'sine',0.3);},600);}};})();

function burst(x,y,colors,count){colors=colors||['#8b5cf6','#ec4899','#fbbf24','#10b981'];count=count||12;for(var i=0;i<count;i++){var p=document.createElement('div');p.className='particle';var a=(i/count)*360;var d=40+Math.random()*70;p.style.cssText='left:'+x+'px;top:'+y+'px;width:'+(4+Math.random()*8)+'px;height:'+(4+Math.random()*8)+'px;background:'+colors[i%colors.length]+';--tx:'+Math.cos(a*Math.PI/180)*d+'px;--ty:'+Math.sin(a*Math.PI/180)*d+'px;animation-duration:'+(0.6+Math.random()*0.4)+'s;';document.body.appendChild(p);setTimeout(function(el){el.remove();}.bind(null,p),1200);}}

// ══════════ THEME ══════════
var currentTheme=localStorage.getItem('sb-theme')||'light';
function applyTheme(){document.documentElement.setAttribute('data-theme',currentTheme);var k=document.getElementById('theme-knob');if(k)k.textContent=currentTheme==='dark'?'🌙':'☀️';}
function toggleTheme(){currentTheme=currentTheme==='light'?'dark':'light';localStorage.setItem('sb-theme',currentTheme);applyTheme();SFX.select();}
applyTheme();

// ══════════ DATA ══════════
var AVATARS=['🦊','🐼','🐸','🦁','🐺','🐻','🦋','🐬','🦄','🐙'];
var GRADES=['Grade 7','Grade 8','Grade 9','Grade 10','Grade 11','Grade 12','College'];
var DECK_COLORS=['#8b5cf6','#ec4899','#fbbf24','#10b981','#3b82f6','#f97316','#14b8a6','#ef4444'];
var TECHNIQUES=[
  {id:'flashcards',name:'Flashcards',icon:'🃏',cval:'#3b82f6',soft:'var(--blue-soft)',screen:'screen-flashcards',desc:'Spaced repetition for rapid recall'},
  {id:'blurting',name:'Blurting',icon:'✍️',cval:'#ec4899',soft:'var(--pink-soft)',screen:'screen-blurting',desc:'Active recall through free writing'},
  {id:'question',name:'Question Method',icon:'❓',cval:'#10b981',soft:'var(--green-soft)',screen:'screen-question',desc:'Cornell note-taking and self-quiz'},
  {id:'feynman',name:'Feynman Technique',icon:'🧑‍🏫',cval:'#f97316',soft:'var(--orange-soft)',screen:'screen-feynman',desc:'Learn by teaching simply'},
  {id:'rrr',name:'Read, Recite, Review',icon:'📖',cval:'#14b8a6',soft:'var(--teal-soft)',screen:'screen-rrr',desc:'Structured reading cycle'},
  {id:'whiteboard',name:'Brain Dump',icon:'🖊️',cval:'#fbbf24',soft:'var(--yellow-soft)',screen:'screen-whiteboard',desc:'Free-form canvas drawing'},
  {id:'diagram',name:'Active Diagramming',icon:'🗺️',cval:'#8b5cf6',soft:'rgba(139,92,246,0.12)',screen:'screen-diagram',desc:'Mind maps and visual thinking'}
];

// Questions array kept same as your original - all 50
var QUESTIONS=[{scenario:"You have a big exam tomorrow on a topic you are somewhat familiar with.",q:"What do you naturally do first?",opts:[{label:"Reread the notes several times",w:{rrr:5,question:2}},{label:"Explain the topic out loud as if teaching someone",w:{feynman:5,blurting:2}},{label:"Create a mind map or diagram of key concepts",w:{diagram:5,whiteboard:3}},{label:"Make flashcards and test yourself repeatedly",w:{flashcards:5}},{label:"Write down everything you remember without looking",w:{blurting:5}}]},{scenario:"Your teacher just finished a long and complex lecture on a new chapter.",q:"How do you process the information afterward?",opts:[{label:"Rewrite my notes in my own simpler words",w:{feynman:4,blurting:3}},{label:"Turn my notes into questions and quiz myself",w:{question:5,flashcards:3}},{label:"Draw a flowchart connecting the main ideas",w:{diagram:5,whiteboard:2}},{label:"Read through my notes again slowly and carefully",w:{rrr:5}},{label:"Write a summary from memory then check for gaps",w:{blurting:5,rrr:2}}]},{scenario:"A classmate asks you to help them understand a topic you studied last week.",q:"How do you explain it?",opts:[{label:"I break it down using simple everyday analogies",w:{feynman:5}},{label:"I draw diagrams or sketches to show them visually",w:{diagram:5,whiteboard:3}},{label:"I quiz them with questions I made earlier",w:{question:5,flashcards:3}},{label:"I walk them through the textbook step by step",w:{rrr:4,question:2}},{label:"I write everything on a board freely to brainstorm together",w:{whiteboard:5,blurting:2}}]},{scenario:"You are studying a topic that feels really confusing and overwhelming.",q:"What is your go-to strategy to push through?",opts:[{label:"Try to explain it to myself as if I am 10 years old",w:{feynman:5}},{label:"Write everything I DO know then see what is missing",w:{blurting:5}},{label:"Read the material again more slowly and take better notes",w:{rrr:5,question:2}},{label:"Create a visual map of how the pieces connect",w:{diagram:5,whiteboard:3}},{label:"Make Q and A flashcards to break it into smaller chunks",w:{flashcards:5,question:2}}]},{scenario:"You only have 20 minutes before class starts and need a quick review.",q:"What do you grab first?",opts:[{label:"My flashcard deck to flip through quickly",w:{flashcards:5}},{label:"A blank paper to brain dump everything I remember",w:{blurting:5,whiteboard:2}},{label:"My notes to skim through the key points one more time",w:{rrr:4}},{label:"My mind map diagram to glance at the overview",w:{diagram:5}},{label:"My list of self-made questions to quiz myself",w:{question:5}}]},{scenario:"You are setting up your ideal study session at home for a 2-hour block.",q:"What does your study plan look like?",opts:[{label:"Read, hide notes, recite, review cycle repeated",w:{rrr:5}},{label:"Create flashcards first then drill them using spaced repetition",w:{flashcards:5}},{label:"Build a big mind map on paper connecting everything",w:{diagram:5,whiteboard:3}},{label:"Write everything from memory, compare to source, repeat",w:{blurting:5}},{label:"Pretend I am teaching the topic to an audience from scratch",w:{feynman:5}}]},{scenario:"You need to memorize a lot of vocabulary or definitions for a test.",q:"What method works best for you?",opts:[{label:"Flashcards with spaced repetition until I know them all",w:{flashcards:5}},{label:"Write the definitions over and over from memory",w:{blurting:4,rrr:2}},{label:"Group related words visually in a concept map",w:{diagram:5}},{label:"Create a quiz with questions about each term",w:{question:5}},{label:"Explain each word in my own simple language",w:{feynman:4,blurting:2}}]},{scenario:"You are studying a complex process like photosynthesis or the water cycle.",q:"What helps you understand it most?",opts:[{label:"Draw a step-by-step diagram with arrows showing the flow",w:{diagram:5,whiteboard:3}},{label:"Explain each step aloud in the simplest possible way",w:{feynman:5}},{label:"Read the textbook explanation carefully then recite it back",w:{rrr:5}},{label:"Make flashcards for each step and shuffle them to test order",w:{flashcards:5}},{label:"Write out the entire process from memory to see what I miss",w:{blurting:5}}]},{scenario:"You are studying with a group for an upcoming project presentation.",q:"What role do you naturally take?",opts:[{label:"The one who explains things clearly to the group",w:{feynman:5}},{label:"The one who creates visual charts and diagrams for everyone",w:{diagram:5,whiteboard:3}},{label:"The one who quizzes the group with prepared questions",w:{question:5,flashcards:3}},{label:"The one who summarizes key points from the material",w:{rrr:4,blurting:2}},{label:"The one who brainstorms ideas freely on the whiteboard",w:{whiteboard:5,blurting:2}}]},{scenario:"You find a really useful study resource online about your topic.",q:"What do you do with the information?",opts:[{label:"Turn the key points into flashcards right away",w:{flashcards:5}},{label:"Read it thoroughly then try to recall the main ideas",w:{rrr:5,blurting:2}},{label:"Create a mind map connecting it to what I already know",w:{diagram:5}},{label:"Write questions that this resource answers",w:{question:5}},{label:"Try to summarize it in my own words as if explaining to a friend",w:{feynman:5}}]},{scenario:"You realize you have been reading the same page for 10 minutes without absorbing anything.",q:"What do you switch to?",opts:[{label:"Close the book and write what I remember from the page",w:{blurting:5}},{label:"Draw a quick sketch or diagram of what I just read",w:{diagram:4,whiteboard:3}},{label:"Try explaining the paragraph to myself out loud",w:{feynman:5}},{label:"Make flashcards from that page to engage more actively",w:{flashcards:4,question:2}},{label:"Read it aloud slowly then cover it and recite",w:{rrr:5}}]},{scenario:"After a study session you want to check how well you learned the material.",q:"How do you test yourself?",opts:[{label:"Flip through my flashcards and see my accuracy rate",w:{flashcards:5}},{label:"Write everything I know on a blank paper",w:{blurting:5,whiteboard:2}},{label:"Answer the questions I wrote in my notes",w:{question:5}},{label:"Try to teach the topic to someone or pretend to",w:{feynman:5}},{label:"Redraw my mind map from memory and compare",w:{diagram:5}}]},{scenario:"You need to study 5 different subjects this week for midterm exams.",q:"How do you organize your study approach?",opts:[{label:"Create flashcard decks for each subject and rotate through them",w:{flashcards:5}},{label:"Schedule read-recite-review cycles for each subject",w:{rrr:5}},{label:"Make a master mind map connecting themes across subjects",w:{diagram:5,whiteboard:2}},{label:"Prepare self-quiz questions for each subject area",w:{question:5}},{label:"Do blurting sessions for each subject to identify weak spots",w:{blurting:5,feynman:2}}]},{scenario:"You got a test back and scored lower than expected on certain topics.",q:"How do you approach reviewing your mistakes?",opts:[{label:"Make flashcards specifically for the topics I got wrong",w:{flashcards:5,question:2}},{label:"Try to explain each wrong answer correctly in simple words",w:{feynman:5}},{label:"Reread those sections carefully and practice reciting them",w:{rrr:5}},{label:"Create a diagram showing how the correct concepts connect",w:{diagram:5}},{label:"Write everything I know about those topics from memory to find gaps",w:{blurting:5}}]},{scenario:"If you could design your dream study tool what would it focus on?",q:"What feature matters most to you?",opts:[{label:"Smart flashcards that know when to show me each card again",w:{flashcards:5}},{label:"A beautiful mind mapping tool with colors and connections",w:{diagram:5,whiteboard:3}},{label:"A system that quizzes me with my own questions",w:{question:5}},{label:"A space to freely write and dump my thoughts",w:{blurting:4,whiteboard:4}},{label:"A guided teaching mode where I explain topics step by step",w:{feynman:5,rrr:2}}]},{scenario:"You are preparing for a history exam with many dates and events to remember.",q:"How do you approach memorizing the timeline?",opts:[{label:"Create a visual timeline diagram with color-coded events",w:{diagram:5,whiteboard:3}},{label:"Make flashcards with dates on one side and events on the other",w:{flashcards:5}},{label:"Read the chapter then recite the key dates from memory",w:{rrr:5}},{label:"Write out the entire timeline from memory and check what I missed",w:{blurting:5}},{label:"Tell the story of history as if narrating it to someone",w:{feynman:5}}]},{scenario:"Your teacher assigns a chapter to read before the next class discussion.",q:"How do you prepare?",opts:[{label:"Read it carefully, then recite the main ideas without looking",w:{rrr:5}},{label:"Write down questions as I read to quiz myself later",w:{question:5}},{label:"Sketch out a concept map while reading",w:{diagram:5}},{label:"After reading, write everything I remember on a blank page",w:{blurting:5}},{label:"Summarize each section in my own words as if teaching a kid",w:{feynman:5}}]},{scenario:"You are learning a new math formula and need to understand when to apply it.",q:"What approach do you take?",opts:[{label:"Practice lots of problems using the formula repeatedly",w:{flashcards:4,rrr:3}},{label:"Write a simple explanation of what the formula does in plain words",w:{feynman:5}},{label:"Create a diagram showing when and where this formula applies",w:{diagram:5}},{label:"Write the formula from memory, then check and repeat",w:{blurting:5}},{label:"Create practice questions for myself about the formula",w:{question:5,flashcards:2}}]},{scenario:"You discover that a classmate uses a completely different study method than you.",q:"What is your reaction?",opts:[{label:"Interesting, but I trust my flashcard routine works for me",w:{flashcards:4}},{label:"I am curious and might try drawing diagrams like they do",w:{diagram:4,whiteboard:3}},{label:"I stick to my method of reading and reciting from memory",w:{rrr:4}},{label:"I try their method of brain dumping to see if it helps",w:{blurting:4}},{label:"I think teaching concepts aloud is still the best approach",w:{feynman:4}}]},{scenario:"Your science class requires you to understand how different body systems connect.",q:"How do you study the relationships between systems?",opts:[{label:"Draw a large interconnected diagram of all the systems",w:{diagram:5,whiteboard:3}},{label:"Make flashcards for each system and how they relate",w:{flashcards:5}},{label:"Explain each connection out loud using simple analogies",w:{feynman:5}},{label:"Write everything I know about the connections from memory",w:{blurting:5}},{label:"Read the textbook section, then write questions about the relationships",w:{question:5,rrr:2}}]},{scenario:"You need to prepare a 5-minute class presentation on a topic you just learned.",q:"How do you prepare your talk?",opts:[{label:"Create a visual diagram or mind map as my presentation guide",w:{diagram:5,whiteboard:3}},{label:"Practice explaining it in the simplest way possible out loud",w:{feynman:5}},{label:"Write flashcard bullet points for each part of the talk",w:{flashcards:4}},{label:"Write out my whole talk from memory first to see what I know",w:{blurting:5}},{label:"Read my notes several times until I feel confident",w:{rrr:5}}]},{scenario:"You are studying for a language class and need to learn new grammar rules.",q:"What approach do you prefer?",opts:[{label:"Flashcards with examples on one side and rules on the other",w:{flashcards:5}},{label:"Write example sentences from memory using the new rules",w:{blurting:5}},{label:"Draw a chart showing how the grammar rules relate to each other",w:{diagram:5}},{label:"Read example sentences then recite the rules without looking",w:{rrr:5}},{label:"Explain the grammar rule as simply as possible in my own words",w:{feynman:5}}]},{scenario:"During a study session, you notice you keep forgetting one specific concept.",q:"What do you do about it?",opts:[{label:"Make an extra flashcard for it and review it more frequently",w:{flashcards:5}},{label:"Try to explain just that concept in the simplest way until it clicks",w:{feynman:5}},{label:"Write it out from memory 5 times to drill it into my brain",w:{blurting:5}},{label:"Draw a diagram specifically about that concept with examples",w:{diagram:5}},{label:"Read the explanation again more carefully and recite it",w:{rrr:5}}]},{scenario:"Your friend asks how you would study for an open-book test.",q:"What strategy do you recommend?",opts:[{label:"Create an organized reference diagram you can quickly scan",w:{diagram:5,whiteboard:2}},{label:"Even for open book, understand the material by teaching it first",w:{feynman:5}},{label:"Prepare question-and-answer notes so you can find info fast",w:{question:5}},{label:"Tab and annotate your book after reading through carefully",w:{rrr:5}},{label:"Still make flashcards since understanding beats just finding answers",w:{flashcards:4,blurting:2}}]},{scenario:"You are studying a topic where you need to compare and contrast two things.",q:"How do you organize the comparison?",opts:[{label:"Draw a Venn diagram or comparison chart",w:{diagram:5,whiteboard:3}},{label:"Make flashcards with similarities on one side and differences on the other",w:{flashcards:5}},{label:"Write both descriptions from memory then compare them",w:{blurting:5}},{label:"Read about both then recite the key differences",w:{rrr:5}},{label:"Explain the differences as if someone asked me to clarify them",w:{feynman:5}}]},{scenario:"You are reviewing for a final exam that covers the entire semester.",q:"How do you plan your review?",opts:[{label:"Build a master mind map connecting all the major topics",w:{diagram:5}},{label:"Go through all my flashcard decks in spaced repetition order",w:{flashcards:5}},{label:"Do a massive brain dump of everything I remember from the semester",w:{blurting:5}},{label:"Re-read my notes chapter by chapter, reciting key points",w:{rrr:5}},{label:"Create a self-quiz covering all the main topics",w:{question:5}}]},{scenario:"A topic has many small details that are easy to confuse with each other.",q:"How do you keep the details straight?",opts:[{label:"Color-coded flashcards to separate the easily confused items",w:{flashcards:5}},{label:"A comparison diagram showing the differences side by side",w:{diagram:5}},{label:"Write each detail from memory then check for accuracy",w:{blurting:5}},{label:"Explain each one aloud emphasizing what makes them different",w:{feynman:5}},{label:"Read each detail carefully multiple times, then quiz myself",w:{rrr:4,question:3}}]},{scenario:"You want to make sure you truly understand a topic, not just memorize it.",q:"What do you do?",opts:[{label:"Try to explain the why behind the topic in simple terms",w:{feynman:5}},{label:"Draw a concept map showing all the cause-and-effect connections",w:{diagram:5}},{label:"Write what I understand from memory and see if it makes sense",w:{blurting:5}},{label:"Create deep thinking questions that test understanding not recall",w:{question:5}},{label:"Read a different source and see if the new explanation clicks",w:{rrr:4,flashcards:2}}]},{scenario:"Your study schedule is packed and you need the most efficient method possible.",q:"What is your most time-efficient study technique?",opts:[{label:"Flashcards because I can do them anywhere in short bursts",w:{flashcards:5}},{label:"Quick brain dumps to instantly identify what I do not know",w:{blurting:5}},{label:"One focused read through with active recitation",w:{rrr:5}},{label:"Rapid mind mapping to get the big picture fast",w:{diagram:4,whiteboard:2}},{label:"Quick teach-back sessions to my study partner",w:{feynman:5}}]},{scenario:"You are studying a topic that involves many cause-and-effect relationships.",q:"How do you map out the causes and effects?",opts:[{label:"Draw a flowchart or causal diagram with arrows",w:{diagram:5,whiteboard:3}},{label:"Make flashcards pairing each cause with its effect",w:{flashcards:5}},{label:"Explain the chain of events in the simplest way possible",w:{feynman:5}},{label:"Write out all the cause-effect pairs from memory",w:{blurting:5}},{label:"Create if-then questions to test each relationship",w:{question:5}}]},{scenario:"You are in a study group and everyone is confused about one topic.",q:"How do you help the group figure it out?",opts:[{label:"Go to the whiteboard and sketch out a diagram together",w:{diagram:5,whiteboard:4}},{label:"Suggest everyone try to explain it in their own words",w:{feynman:5}},{label:"Pull out flashcards or key terms to rebuild from basics",w:{flashcards:4}},{label:"Suggest everyone writes what they know then compares notes",w:{blurting:5}},{label:"Propose reading the source material aloud together",w:{rrr:5}}]},{scenario:"You are starting to study a brand new subject you know nothing about.",q:"How do you begin learning from zero?",opts:[{label:"Read an overview first to get the big picture, then recite key ideas",w:{rrr:5}},{label:"Start drawing a mind map as I discover new concepts",w:{diagram:5}},{label:"Try to explain what little I know and build from there",w:{feynman:4,blurting:2}},{label:"Begin making flashcards for every new term I encounter",w:{flashcards:5}},{label:"Write down questions as I go to guide my learning",w:{question:5}}]},{scenario:"You notice your grades improved after changing your study technique last month.",q:"What change made the biggest difference?",opts:[{label:"Switching to active flashcard review instead of passive reading",w:{flashcards:5}},{label:"Starting to draw concept maps for every chapter",w:{diagram:5}},{label:"Beginning to write brain dumps before checking my notes",w:{blurting:5}},{label:"Learning to explain topics simply like the Feynman technique",w:{feynman:5}},{label:"Adopting the read-recite-review cycle consistently",w:{rrr:5}}]},{scenario:"You have a creative writing assignment but need to understand the literary terms first.",q:"How do you learn the literary vocabulary?",opts:[{label:"Flashcards with terms and examples from literature",w:{flashcards:5}},{label:"A visual map showing how literary terms relate to each other",w:{diagram:5}},{label:"Write my own examples of each term from memory",w:{blurting:5}},{label:"Explain each term as if describing it to someone who has never read literature",w:{feynman:5}},{label:"Read definitions multiple times then quiz myself on them",w:{rrr:4,question:3}}]},{scenario:"You realize your notes from class are messy and disorganized.",q:"How do you reorganize them for studying?",opts:[{label:"Create a clean mind map or diagram from the messy notes",w:{diagram:5,whiteboard:3}},{label:"Turn the notes into organized Q and A flashcards",w:{flashcards:5,question:2}},{label:"Rewrite the notes in a structured Cornell note format with questions",w:{question:5}},{label:"Read through them and rewrite a cleaner summary",w:{rrr:5}},{label:"Write what I remember without looking, then fill in gaps from notes",w:{blurting:5}}]},{scenario:"Your textbook chapter is extremely long with lots of dense paragraphs.",q:"How do you tackle reading such a long chapter?",opts:[{label:"Break it into sections and recite key points after each one",w:{rrr:5}},{label:"Skim first for headings then build a chapter mind map",w:{diagram:5}},{label:"Read and convert important parts into flashcards as I go",w:{flashcards:5}},{label:"Read each section then write a brain dump before moving on",w:{blurting:5}},{label:"After reading, try to teach each section to myself simply",w:{feynman:5}}]},{scenario:"You are studying for a geography exam and need to know locations and capitals.",q:"What is your strategy for spatial memorization?",opts:[{label:"Draw and label maps by hand from memory",w:{diagram:5,whiteboard:4}},{label:"Flashcards with country names and their capitals",w:{flashcards:5}},{label:"Recite lists of countries and capitals out loud repeatedly",w:{rrr:5}},{label:"Write all the capitals I can remember then check what I missed",w:{blurting:5}},{label:"Create silly stories or explanations connecting countries to their capitals",w:{feynman:4,question:2}}]},{scenario:"You want to help a younger sibling study for their test.",q:"What study method do you teach them?",opts:[{label:"Show them how to make simple flashcards for key terms",w:{flashcards:5}},{label:"Teach them to draw pictures and diagrams of what they learn",w:{diagram:5,whiteboard:3}},{label:"Have them try to explain the topic back to you in simple words",w:{feynman:5}},{label:"Tell them to read a section then try to remember it without looking",w:{rrr:5}},{label:"Ask them to write everything they know then check the book",w:{blurting:5}}]},{scenario:"During a test, you struggle to recall information you studied.",q:"Looking back, what would you change about your study approach?",opts:[{label:"I should have tested myself more with flashcards",w:{flashcards:5}},{label:"I should have practiced writing from memory more often",w:{blurting:5}},{label:"I should have made a visual summary I could picture in my mind",w:{diagram:5}},{label:"I should have practiced explaining it out loud more",w:{feynman:5}},{label:"I should have recited the material more after reading it",w:{rrr:5}}]},{scenario:"You are learning about a controversial topic with multiple perspectives.",q:"How do you study the different viewpoints?",opts:[{label:"Create a comparison diagram showing all perspectives side by side",w:{diagram:5}},{label:"Make flashcards with each perspective and its key arguments",w:{flashcards:5}},{label:"Try to explain each perspective fairly in simple words",w:{feynman:5}},{label:"Write out each viewpoint from memory then check for completeness",w:{blurting:5}},{label:"Read each perspective carefully then write questions about them",w:{question:5,rrr:2}}]},{scenario:"Your teacher announces a pop quiz next class on recent material.",q:"How do you quickly prepare tonight?",opts:[{label:"Speed-make flashcards for the most important terms and concepts",w:{flashcards:5}},{label:"Do a rapid brain dump of everything from recent classes",w:{blurting:5}},{label:"Quick scan through notes then recite the highlights",w:{rrr:5}},{label:"Draw a one-page summary diagram of all recent topics",w:{diagram:5}},{label:"Explain each recent topic to myself quickly in simple terms",w:{feynman:5}}]},{scenario:"You are preparing for an essay exam where you need to write long answers.",q:"How do you prepare for essay-style questions?",opts:[{label:"Practice writing full answers from memory on potential questions",w:{blurting:5}},{label:"Make an outline diagram for each possible essay topic",w:{diagram:5}},{label:"Prepare flashcards with key evidence and arguments for each topic",w:{flashcards:4,question:2}},{label:"Practice explaining each topic structure clearly out loud",w:{feynman:5}},{label:"Read model essays then recite the structure and key points",w:{rrr:5}}]},{scenario:"Your study space is quiet and you have 45 minutes of focused time.",q:"What is your ideal solo study activity?",opts:[{label:"Flip through my flashcard decks with full concentration",w:{flashcards:5}},{label:"Deep brain dump session where I write everything I know",w:{blurting:5}},{label:"Carefully read and recite material in a structured cycle",w:{rrr:5}},{label:"Build a detailed concept map of the current chapter",w:{diagram:5,whiteboard:3}},{label:"Practice teaching the topic to an imaginary student",w:{feynman:5}}]},{scenario:"You finished studying and feel somewhat confident but not completely sure.",q:"What is your final check before the exam?",opts:[{label:"One last run through my flashcards focusing on the ones I keep missing",w:{flashcards:5}},{label:"A final brain dump to see if anything is still missing",w:{blurting:5}},{label:"Glance at my mind map for a visual overview of everything",w:{diagram:5}},{label:"Try to explain the hardest concepts one more time out loud",w:{feynman:5}},{label:"Quick re-read of the summary notes I prepared",w:{rrr:5}}]},{scenario:"You need to study a chapter that involves many labeled diagrams in the textbook.",q:"How do you learn from visual textbook content?",opts:[{label:"Redraw the diagrams from memory and compare to the originals",w:{diagram:5,whiteboard:4}},{label:"Make flashcards with diagram labels on one side and descriptions on the other",w:{flashcards:5}},{label:"Cover the labels and try to recite what each part is",w:{rrr:5,blurting:2}},{label:"Explain what each part of the diagram does in simple terms",w:{feynman:5}},{label:"Write questions about each labeled component",w:{question:5}}]},{scenario:"You are revising for a multiple choice exam.",q:"What preparation strategy do you trust most?",opts:[{label:"Flashcards that mimic the question-answer format of the test",w:{flashcards:5}},{label:"Writing practice questions and trying to answer them",w:{question:5}},{label:"Doing brain dumps to make sure I have broad topic coverage",w:{blurting:5}},{label:"Explaining the why behind common wrong answers to myself",w:{feynman:5}},{label:"Reviewing all notes thoroughly, reading and reciting key facts",w:{rrr:5}}]},{scenario:"You realize you learn better at certain times of the day.",q:"Regardless of when, how do you maximize your best study time?",opts:[{label:"Tackle the hardest flashcard decks during peak focus time",w:{flashcards:5}},{label:"Do my most intensive brain dump sessions when I am sharpest",w:{blurting:5}},{label:"Save complex diagram creation for when I have the most energy",w:{diagram:5}},{label:"Practice my Feynman explanations when I can think most clearly",w:{feynman:5}},{label:"Do focused read-recite-review cycles during prime study hours",w:{rrr:5}}]},{scenario:"Your study materials include videos, textbooks, and class notes from three different sources.",q:"How do you consolidate all these sources?",opts:[{label:"Create one unified mind map that combines all three sources",w:{diagram:5,whiteboard:3}},{label:"Make comprehensive flashcards pulling from all three",w:{flashcards:5}},{label:"Write everything I remember from all sources then check each one",w:{blurting:5}},{label:"Read through all three then write synthesis questions",w:{question:5,rrr:2}},{label:"Explain the full topic using info from all sources in simple words",w:{feynman:5}}]},{scenario:"You are studying with background music playing.",q:"What study activity works best with music?",opts:[{label:"Flipping through flashcards with a steady rhythm",w:{flashcards:5}},{label:"Free writing and brain dumping thoughts onto paper",w:{blurting:5,whiteboard:3}},{label:"Drawing colorful mind maps and diagrams",w:{diagram:5,whiteboard:4}},{label:"Reading and re-reading my notes peacefully",w:{rrr:5}},{label:"Quietly practicing my explanations in my head",w:{feynman:4}}]},{scenario:"You need to remember the order of steps in a scientific procedure.",q:"How do you memorize the correct sequence?",opts:[{label:"Draw a numbered flowchart showing each step in order",w:{diagram:5,whiteboard:3}},{label:"Make flashcards for each step and practice putting them in order",w:{flashcards:5}},{label:"Write the steps from memory and check if the order is right",w:{blurting:5}},{label:"Recite the steps out loud like a checklist until memorized",w:{rrr:5}},{label:"Explain why each step comes in that particular order",w:{feynman:5}}]}];

var TIPS=["Spaced repetition is 2-3x more effective than cramming.","The Feynman Technique reveals gaps instantly.","Rest days are not lazy days. Sleep consolidates memory.","Short sessions beat long marathons.","Blurting immediately after reading shows you exactly what you missed.","Color-coding your diagrams improves recall by up to 50 percent.","The best time to review a flashcard is right before you would forget it.","Reciting out loud engages more of your brain than silently rereading."];

var ACHIEVEMENTS_DEF=[{key:'first_profile',icon:'👤',name:'Identity Found',desc:'Created your first profile',rarity:'common'},{key:'quiz_complete',icon:'🧠',name:'Self-Aware Learner',desc:'Completed the 50-question assessment',rarity:'common'},{key:'first_fc',icon:'🃏',name:'First Flip',desc:'Reviewed your first flashcard',rarity:'common'},{key:'first_blurt',icon:'✍️',name:'Brain Unlocked',desc:'Completed a Blurting session',rarity:'common'},{key:'first_sched',icon:'📅',name:'Planner Pro',desc:'Added your first study session',rarity:'common'},{key:'first_timer',icon:'⏱',name:'Time Keeper',desc:'Completed a Pomodoro focus session',rarity:'common'},{key:'first_wb',icon:'🖊️',name:'Canvas Pioneer',desc:'Saved your first Brain Dump',rarity:'common'},{key:'streak_3',icon:'🔥',name:'On Fire',desc:'Studied 3 days in a row',rarity:'rare'},{key:'streak_7',icon:'💥',name:'Unstoppable',desc:'7-day study streak',rarity:'rare'},{key:'five_decks',icon:'🗂️',name:'Deck Builder',desc:'Created 5 flashcard decks',rarity:'rare'},{key:'feynman_5',icon:'🧑‍🏫',name:'Little Professor',desc:'5 Feynman sessions',rarity:'rare'},{key:'diagram_5',icon:'🗺️',name:'Map Maker',desc:'5 diagrams saved',rarity:'rare'},{key:'all_techniques',icon:'🌈',name:'Technique Explorer',desc:'Used all 7 techniques',rarity:'epic'},{key:'hours_10',icon:'⏰',name:'10-Hour Club',desc:'10+ hours studied',rarity:'epic'},{key:'study_balance',icon:'🧘',name:'Balance Master',desc:'3+ rest days scheduled',rarity:'epic'},{key:'blurt_10',icon:'📝',name:'Blurt Champion',desc:'10 Blurting sessions',rarity:'epic'},{key:'all_ach',icon:'🌟',name:'StudyBuddy Legend',desc:'Every achievement unlocked',rarity:'legendary'},{key:'hours_50',icon:'💯',name:'Century Scholar',desc:'50+ hours studied',rarity:'legendary'}];

// ══════════ STATE ══════════
var S={profile:null,quizAnswers:{},scores:{},topTech:null,xp:0,ach:[],sessions:[],restDays:[],streak:0,lastStudy:null,decks:[],techUsed:{},mins:0,feynmanCt:0,diagCt:0,blurtCt:0};
var curScreen='',prevScreen='',quizQ=0,isTransitioning=false;
var timerInt=null,timerSecs=25*60,timerOn=false,timerPhase='focus',pomoCt=0;
var tpH=2,tpM=0,tpAMPM='PM';
var NAV_ORDER={home:0,study:1,schedule:2,achievements:3};
var NAV_SCREENS={home:'screen-home',study:'screen-study',schedule:'screen-schedule',achievements:'screen-achievements'};

function save(){try{localStorage.setItem('sb5',JSON.stringify(S));}catch(e){}}
function load(){try{var d=localStorage.getItem('sb5');if(d){S=Object.assign(S,JSON.parse(d));return true;}}catch(e){}return false;}
function esc(t){return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');}

// ══════════ ROBUST NAVIGATION SYSTEM ══════════
function navigateTo(id, animType){
  if(isTransitioning||id===curScreen)return;
  isTransitioning=true;
  animType=animType||'default';

  var oldEl=curScreen?document.getElementById(curScreen):null;
  var newEl=document.getElementById(id);
  if(!newEl){isTransitioning=false;return;}

  var exitClass='exiting';
  var enterClass='entering';

  if(animType==='left'){exitClass='exiting-left';enterClass='entering-left';}
  else if(animType==='right'){exitClass='exiting-right';enterClass='entering-right';}
  else if(animType==='up'){exitClass='exiting';enterClass='entering-up';}
  else if(animType==='down'){exitClass='exiting-down';enterClass='entering';}

  // Exit old screen
  if(oldEl&&oldEl!==newEl){
    oldEl.classList.add(exitClass);
    var oldRef=oldEl;
    var exitRef=exitClass;
    setTimeout(function(){
      oldRef.classList.remove('active',exitRef);
      oldRef.style.display='';
    },400);
  }

  // Enter new screen
  var delay=oldEl&&oldEl!==newEl?120:0;
  setTimeout(function(){
    newEl.classList.add('active');
    newEl.classList.add(enterClass);
    var enterRef=enterClass;
    setTimeout(function(){
      newEl.classList.remove(enterRef);
      isTransitioning=false;
    },550);
  },delay);

  prevScreen=curScreen;
  curScreen=id;
  SFX.navigate();
}

function goBack(){navigateTo(prevScreen||'screen-study','down');}

function switchNav(tab){
  var scr=NAV_SCREENS[tab];
  if(!scr||scr===curScreen)return;

  // Determine direction
  var curTab='home';
  Object.keys(NAV_SCREENS).forEach(function(k){if(NAV_SCREENS[k]===curScreen)curTab=k;});
  var dir=NAV_ORDER[tab]>NAV_ORDER[curTab]?'left':'right';

  SFX.whoosh();
  navigateTo(scr,dir);

  if(tab==='achievements')renderAch();
  if(tab==='schedule'){renderSched();renderSessList();}
  if(tab==='study')renderStudyList();
  if(tab==='home')renderHome();

  setTimeout(function(){
    document.querySelectorAll('.bottom-nav').forEach(function(nav){
      nav.querySelectorAll('.nav-item').forEach(function(n,i){
        n.classList.toggle('active',['home','study','schedule','achievements'][i]===tab);
      });
    });
  },50);
}

function openTech(id){if(!S.techUsed)S.techUsed={};S.techUsed[id]=(S.techUsed[id]||0)+1;save();if(Object.keys(S.techUsed).length>=7)unlock('all_techniques');var t=TECHNIQUES.find(function(x){return x.id===id;});if(!t)return;switch(id){case'flashcards':initFC();break;case'blurting':initBlurt();break;case'question':initCornell();break;case'feynman':initFeynman();break;case'rrr':initRRR();break;case'whiteboard':navigateTo(t.screen,'up');setTimeout(initWB,250);return;case'diagram':navigateTo(t.screen,'up');setTimeout(initDiag,250);return;}navigateTo(t.screen,'up');}

// ══════════ SPLASH WITH STARTUP SOUND ══════════
function hideSplash(){
  setTimeout(function(){
    SFX.startup();
  },1500);

  setTimeout(function(){
    var sp=document.getElementById('splash');
    sp.classList.add('exit');
    burst(window.innerWidth/2,window.innerHeight/2,['#c084fc','#f0abfc','#fbbf24','#60a5fa','#f472b6'],20);
    setTimeout(function(){
      sp.style.display='none';
    },900);
    var loaded=load();
    if(loaded&&S.profile&&S.scores&&Object.keys(S.scores).length>0){
      renderHome();navigateTo('screen-home');
    }else{
      initSetup();navigateTo('screen-welcome');
    }
  },3800);
}

// ══════════ SETUP ══════════
var selectedAvatarIdx=0,selGr='';
function initSetup(){var ag=document.getElementById('av-grid');ag.innerHTML=AVATARS.map(function(a,i){return'<div class="av-opt '+(i===0?'sel':'')+'" data-idx="'+i+'">'+a+'</div>';}).join('');ag.onclick=function(e){var opt=e.target.closest('.av-opt');if(!opt)return;selectedAvatarIdx=parseInt(opt.dataset.idx);ag.querySelectorAll('.av-opt').forEach(function(el,j){el.classList.toggle('sel',j===selectedAvatarIdx);});SFX.select();};var gg=document.getElementById('gr-grid');gg.innerHTML=GRADES.map(function(g){return'<div class="grade-opt" data-grade="'+g+'">'+g+'</div>';}).join('');gg.onclick=function(e){var opt=e.target.closest('.grade-opt');if(!opt)return;selGr=opt.dataset.grade;gg.querySelectorAll('.grade-opt').forEach(function(el){el.classList.remove('sel');});opt.classList.add('sel');SFX.select();};}
function saveProfile(){var name=document.getElementById('inp-name').value.trim();if(!name){showToast('Please enter your name');SFX.error();return;}if(!selGr){showToast('Please pick your grade level');SFX.error();return;}S.profile={name:name,avatar:AVATARS[selectedAvatarIdx],grade:selGr};save();unlock('first_profile');startQuiz();}
function loadExisting(){if(load()&&S.profile){renderHome();navigateTo('screen-home');}else{showToast('No saved profile found');SFX.error();}}

// ══════════ QUIZ ══════════
function startQuiz(){S.quizAnswers={};quizQ=0;navigateTo('screen-quiz');renderQ();}
function renderQ(){var q=QUESTIONS[quizQ];var pct=((quizQ+1)/QUESTIONS.length*100).toFixed(1);document.getElementById('q-prog').style.width=pct+'%';document.getElementById('q-num').textContent='Q'+(quizQ+1)+' / '+QUESTIONS.length;document.getElementById('q-hint').textContent='Results at Q'+QUESTIONS.length;var sel=S.quizAnswers[quizQ];document.getElementById('q-body').innerHTML='<div class="quiz-scenario"><div class="scenario-label">Scenario</div><div style="font-size:15px;font-weight:700;color:var(--text);line-height:1.5;">'+q.scenario+'</div></div><div class="quiz-qtext">'+q.q+'</div><div class="quiz-opts">'+q.opts.map(function(o,i){return'<div class="quiz-opt '+(sel===i?'sel':'')+'" onclick="pickQ('+i+',this)"><div class="quiz-dot">'+(sel===i?'&#10003;':'')+'</div><span>'+String.fromCharCode(65+i)+'. '+o.label+'</span></div>';}).join('')+'</div>';document.getElementById('q-prev').style.opacity=quizQ===0?'0.35':'1';document.getElementById('q-next').textContent=quizQ===QUESTIONS.length-1?'See My Results':'Next';}
function pickQ(v,el){S.quizAnswers[quizQ]=v;document.querySelectorAll('.quiz-opt').forEach(function(o){o.classList.remove('sel');o.querySelector('.quiz-dot').innerHTML='';});el.classList.add('sel');el.querySelector('.quiz-dot').innerHTML='&#10003;';SFX.select();}
function qNext(){if(S.quizAnswers[quizQ]===undefined){showToast('Please select an answer');SFX.error();return;}if(quizQ<QUESTIONS.length-1){quizQ++;renderQ();}else computeResults();}
function qPrev(){if(quizQ>0){quizQ--;renderQ();}}
function computeResults(){var sc={};TECHNIQUES.forEach(function(t){sc[t.id]=0;});QUESTIONS.forEach(function(q,i){var ai=S.quizAnswers[i];if(ai===undefined)return;var o=q.opts[ai];if(o&&o.w)Object.keys(o.w).forEach(function(id){if(sc[id]!==undefined)sc[id]+=o.w[id];});});var vals=Object.keys(sc).map(function(k){return sc[k];});var max=Math.max.apply(null,vals.concat([1]));var norm={};Object.keys(sc).forEach(function(k){norm[k]=Math.round(sc[k]/max*100);});S.scores=norm;var sorted=Object.keys(norm).sort(function(a,b){return norm[b]-norm[a];});S.topTech=sorted[0];save();unlock('quiz_complete');renderResults();navigateTo('screen-results');SFX.success();setTimeout(function(){burst(window.innerWidth/2,window.innerHeight/2);},300);}
function renderResults(){var sorted=Object.keys(S.scores).sort(function(a,b){return S.scores[b]-S.scores[a];});var tm={};TECHNIQUES.forEach(function(t){tm[t.id]=t;});var medals=['🥇','🥈','🥉'];document.getElementById('r-sub').textContent='Hi '+S.profile.name+'! Here is how your techniques scored:';document.getElementById('r-body').innerHTML=sorted.map(function(id,i){var t=tm[id];var pct=S.scores[id];if(!t)return'';return'<div class="result-card" style="background:'+t.soft+';border-color:'+t.cval+'40;color:'+t.cval+';" onclick="openTech(\''+id+'\')"><div class="result-rank">'+(medals[i]||'#'+(i+1))+'</div><div class="result-info"><h4>'+t.icon+' '+t.name+'</h4><p>'+t.desc+'</p></div><div class="result-pct-wrap"><div class="result-pct">'+pct+'%</div><div class="result-pct-label">match</div></div><div class="result-bar-bg"><div class="result-bar-fill" style="background:'+t.cval+';width:0%;" data-w="'+pct+'"></div></div></div>';}).join('');setTimeout(function(){document.querySelectorAll('.result-bar-fill').forEach(function(b){b.style.width=b.dataset.w+'%';});},200);}
function goToHome(){renderHome();navigateTo('screen-home');}

// ══════════ HOME ══════════
function renderHome(){if(!S.profile)return;document.getElementById('g-name').textContent=S.profile.name+' '+S.profile.avatar;document.getElementById('home-av').textContent=S.profile.avatar;var h=new Date().getHours();document.getElementById('greeting-time').textContent=(h<12?'Good morning,':h<17?'Good afternoon,':'Good evening,');var lv=Math.floor(S.xp/200)+1,xI=S.xp%200;document.getElementById('xp-lv').textContent=lv;document.getElementById('xp-cur').textContent=xI;document.getElementById('xp-nxt').textContent=200;document.getElementById('xp-bar').style.width=(xI/200*100)+'%';renderStreakDays();var sorted=S.scores?Object.keys(S.scores).sort(function(a,b){return S.scores[b]-S.scores[a];}):[];document.getElementById('home-tech-grid').innerHTML=TECHNIQUES.map(function(t){var rank=sorted.indexOf(t.id)+1;var pct=S.scores[t.id]||0;return'<div class="tc" onclick="SFX.tap();openTech(\''+t.id+'\')"><div style="position:absolute;top:0;left:0;right:0;height:4px;border-radius:var(--r-lg) var(--r-lg) 0 0;background:'+t.cval+';"></div>'+(rank===1?'<div class="tc-badge tc-best">Best</div>':(rank>0&&rank<=3?'<div class="tc-badge tc-match">#'+rank+'</div>':''))+'<span class="tc-icon">'+t.icon+'</span><div class="tc-name">'+t.name+'</div><div class="tc-desc">'+t.desc+'</div>'+(pct>0?'<div style="margin-top:8px;height:5px;background:var(--surface3);border-radius:3px;overflow:hidden;"><div style="height:100%;width:'+pct+'%;background:'+t.cval+';border-radius:3px;transition:width 1s;"></div></div>':'')+'</div>';}).join('');document.querySelector('#daily-tip p').textContent=TIPS[new Date().getDate()%TIPS.length];applyTheme();}
function renderStreakDays(){var days=['Su','Mo','Tu','We','Th','Fr','Sa'];var today=new Date().getDay();document.getElementById('streak-days').innerHTML=days.map(function(d,i){var isT=i===today;var isD=S.sessions.some(function(s){var sd=new Date(s.date);return sd.getDay()===i&&(new Date()-sd)<7*86400000;});return'<div class="sday '+(isT?'today':'')+' '+(isD?'done':'')+'"><span>'+d+'</span>'+(isD||isT?'<div class="sday-dot"></div>':'')+'</div>';}).join('');document.getElementById('streak-n').textContent=S.streak||0;}
function renderStudyList(){var sorted=S.scores?Object.keys(S.scores).sort(function(a,b){return S.scores[b]-S.scores[a];}):[];document.getElementById('study-list-body').innerHTML='<div class="section-label" style="margin-bottom:12px;">Choose a technique</div>'+TECHNIQUES.map(function(t){var rank=sorted.indexOf(t.id)+1;var pct=S.scores[t.id]||0;return'<div class="tech-list-item" onclick="SFX.tap();openTech(\''+t.id+'\')"><span class="tli-icon">'+t.icon+'</span><div class="tli-info"><div class="tli-name">'+t.name+'</div><div class="tli-desc">'+t.desc+'</div>'+(pct>0?'<div class="tli-match" style="background:'+t.soft+';color:'+t.cval+';">'+(rank===1?'Best match':'#'+rank)+' '+pct+'%</div>':'')+'</div><span style="color:var(--text3);font-size:20px;">&#8250;</span></div>';}).join('');}

// ══════════ FLASHCARDS ══════════
var fcDeckIdx=null,fcCardIdx=0,fcFlipped=false,newDeckColor=DECK_COLORS[0];
function initFC(){switchFcTab('decks',document.querySelector('.fc-tab'));renderFCDecks();renderFCCreate();renderFCAI();}
function switchFcTab(tab,el){var tabs=['decks','create','ai'];document.querySelectorAll('.fc-tab').forEach(function(t,i){t.classList.toggle('active',tabs[i]===tab);});document.querySelectorAll('.fc-section').forEach(function(s){s.classList.remove('active');});var sec=document.getElementById('fc-'+tab);if(sec)sec.classList.add('active');if(el){document.querySelectorAll('.fc-tab').forEach(function(t){t.classList.remove('active');});el.classList.add('active');}}
function renderFCDecks(){var el=document.getElementById('fc-decks');if(!S.decks||S.decks.length===0){el.innerHTML='<div style="text-align:center;padding:48px 20px;color:var(--text3);"><div style="font-size:52px;margin-bottom:14px;">🃏</div><div style="font-size:16px;font-weight:800;margin-bottom:6px;color:var(--text);">No decks yet!</div><div style="font-size:13px;">Go to Create or AI Gen to get started.</div></div>';return;}el.innerHTML=S.decks.map(function(d,i){return'<div class="deck-card" onclick="SFX.tap();openDeck('+i+')"><div class="deck-dot" style="background:'+d.color+';"></div><div class="deck-info"><h4>'+esc(d.name)+'</h4><p>'+(d.subject||'General')+' - '+d.cards.length+' cards</p></div><div class="deck-count">'+d.cards.length+'</div><button onclick="event.stopPropagation();deleteDeck('+i+')" style="background:none;border:none;color:var(--text3);cursor:pointer;padding:4px;font-size:16px;">x</button></div>';}).join('');}
function renderFCCreate(){document.getElementById('fc-create').innerHTML='<div class="create-deck-form"><h4>New Deck</h4><div class="form-group"><label class="form-label">Deck Name</label><input class="form-input" id="new-deck-name" placeholder="e.g. Chapter 3"></div><div class="form-group"><label class="form-label">Subject</label><input class="form-input" id="new-deck-subj" placeholder="e.g. Biology"></div><div class="form-group"><label class="form-label">Color</label><div class="color-picker">'+DECK_COLORS.map(function(c){return'<div class="color-swatch '+(c===newDeckColor?'sel':'')+'" style="background:'+c+';" onclick="newDeckColor=\''+c+'\';document.querySelectorAll(\'.color-swatch\').forEach(function(s){s.classList.remove(\'sel\');});this.classList.add(\'sel\');SFX.pop();"></div>';}).join('')+'</div></div><button class="btn btn-primary btn-full" onclick="createDeck()">Create Deck</button></div>';}
function createDeck(){var name=document.getElementById('new-deck-name').value.trim();var subj=document.getElementById('new-deck-subj').value.trim();if(!name){showToast('Please name your deck');SFX.error();return;}if(!S.decks)S.decks=[];S.decks.push({name:name,subject:subj,color:newDeckColor,cards:[]});save();if(S.decks.length>=5)unlock('five_decks');renderFCDecks();renderFCCreate();showToast('Deck created! +10 XP');addXP(10);switchFcTab('decks',null);document.querySelector('.fc-tab').classList.add('active');SFX.correct();}
function deleteDeck(i){if(!confirm('Delete this deck?'))return;S.decks.splice(i,1);save();renderFCDecks();showToast('Deck deleted');}
function openDeck(i){fcDeckIdx=i;fcCardIdx=0;fcFlipped=false;renderFCStudy();switchFcTab('study',null);}
function renderFCStudy(){var deck=S.decks[fcDeckIdx];var el=document.getElementById('fc-study');var card=deck.cards[fcCardIdx];el.innerHTML='<div style="display:flex;align-items:center;margin-bottom:12px;"><button class="btn btn-ghost btn-sm" onclick="SFX.tap();switchFcTab(\'decks\',document.querySelector(\'.fc-tab\'))">Back</button><span style="font-size:14px;font-weight:800;flex:1;text-align:center;color:var(--text);">'+esc(deck.name)+'</span><span class="pill">'+deck.cards.length+' cards</span></div>'+(deck.cards.length===0?'<div style="text-align:center;padding:40px 0;color:var(--text3);"><div style="font-size:52px;margin-bottom:14px;">🃏</div><div style="font-size:15px;font-weight:800;margin-bottom:16px;color:var(--text);">No cards yet!</div></div>':'<div class="fc-scene" onclick="flipCard()"><div class="fc-inner '+(fcFlipped?'flipped':'')+'" id="fc-inner"><div class="fc-face" style="border-color:'+deck.color+'40;"><div class="fc-face-label">QUESTION</div><div class="fc-face-text">'+(card?esc(card.front):'...')+'</div><div class="fc-face-hint">Tap to flip</div></div><div class="fc-face fc-back-face" style="border-color:'+deck.color+'60;"><div class="fc-face-label">ANSWER</div><div class="fc-face-text">'+(card?esc(card.back):'...')+'</div></div></div></div><div class="fc-rate-btns"><div class="fc-rate fc-again" onclick="rateCard(\'again\')">Again</div><div class="fc-rate fc-hard" onclick="rateCard(\'hard\')">Hard</div><div class="fc-rate fc-good" onclick="rateCard(\'good\')">Easy</div></div><div style="text-align:center;font-size:12px;font-weight:700;color:var(--text3);margin-bottom:16px;">Card '+(fcCardIdx+1)+' of '+deck.cards.length+'</div>')+'<div class="create-deck-form"><h4>Add New Card</h4><textarea class="form-input" id="fc-front" placeholder="Question or term" style="margin-bottom:8px;min-height:70px;"></textarea><textarea class="form-input" id="fc-back" placeholder="Answer or definition" style="margin-bottom:10px;min-height:70px;"></textarea><button class="btn btn-primary btn-full" onclick="addCard()">Add Card</button></div>';}
function flipCard(){fcFlipped=!fcFlipped;var el=document.getElementById('fc-inner');if(el){el.classList.toggle('flipped',fcFlipped);SFX.flip();}}
function rateCard(r){var deck=S.decks[fcDeckIdx];if(!deck||deck.cards.length===0)return;fcFlipped=false;if(r==='good'||r==='hard')fcCardIdx=(fcCardIdx+1)%deck.cards.length;addXP(r==='good'?10:5);unlock('first_fc');if(r==='good')SFX.correct();else SFX.tap();renderFCStudy();}
function addCard(){var f=document.getElementById('fc-front').value.trim();var b=document.getElementById('fc-back').value.trim();if(!f||!b){showToast('Fill in both sides');SFX.error();return;}S.decks[fcDeckIdx].cards.push({front:f,back:b});save();showToast('Card added');SFX.correct();renderFCStudy();}

// AI Gen
function renderFCAI(){document.getElementById('fc-ai').innerHTML='<div class="ai-gen-box"><h4>AI Flashcard Generator</h4><p>Upload a photo, PDF, or paste text. AI creates accurate flashcards.</p><div class="upload-area" onclick="document.getElementById(\'file-input\').click()" ondragover="event.preventDefault();this.classList.add(\'drag\');" ondragleave="this.classList.remove(\'drag\');" ondrop="event.preventDefault();this.classList.remove(\'drag\');if(event.dataTransfer.files[0])handleFile(event.dataTransfer.files[0]);"><input type="file" id="file-input" accept="image/*,.pdf,.txt" style="display:none" onchange="handleFile(this.files[0])"><span class="upload-icon">📁</span><div class="upload-text">Tap to upload</div><div class="upload-hint">Images, PDF, Text</div></div><div id="upload-status-area"></div><div style="text-align:center;font-size:13px;font-weight:700;color:var(--text3);margin:8px 0;">or paste text below</div><textarea class="form-input" id="ai-text-input" placeholder="Paste notes here..." style="min-height:120px;margin-bottom:10px;"></textarea><input class="form-input" id="ai-deck-name" placeholder="Deck name" style="margin-bottom:10px;"><button class="btn btn-primary btn-full" onclick="generateCards()">Generate Flashcards</button></div><div id="ai-preview"></div>';}

async function handleFile(file){if(!file)return;var sa=document.getElementById('upload-status-area');if(file.type==='text/plain'){var r=new FileReader();r.onload=function(e){document.getElementById('ai-text-input').value=e.target.result;sa.innerHTML='<div class="upload-status upload-success">Text loaded: '+esc(file.name)+'</div>';showToast('Text loaded');SFX.correct();};r.readAsText(file);}else if(file.type.startsWith('image/')){sa.innerHTML='<div class="upload-status upload-loading"><div class="spinner"></div> Extracting text...</div>';try{var res=await Tesseract.recognize(file,'eng');var txt=res.data.text.trim();if(txt.length>10){document.getElementById('ai-text-input').value=txt;sa.innerHTML='<div class="upload-status upload-success">Extracted '+txt.split(' ').length+' words</div>';SFX.success();}else{sa.innerHTML='<div class="upload-status" style="background:var(--yellow-soft);color:var(--orange);border:1px solid rgba(249,115,22,0.3);">Low text found</div>';SFX.error();}}catch(err){sa.innerHTML='<div class="upload-status" style="background:var(--red-soft);color:var(--red);border:1px solid rgba(239,68,68,0.3);">OCR failed</div>';SFX.error();}}else if(file.type==='application/pdf'){sa.innerHTML='<div class="upload-status upload-loading"><div class="spinner"></div> Extracting PDF...</div>';try{var ab=await file.arrayBuffer();pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';var pdf=await pdfjsLib.getDocument({data:ab}).promise;var all='';for(var i=1;i<=Math.min(pdf.numPages,20);i++){var pg=await pdf.getPage(i);var ct=await pg.getTextContent();all+=ct.items.map(function(x){return x.str;}).join(' ')+'\n';}all=all.trim();if(all.length>20){document.getElementById('ai-text-input').value=all;sa.innerHTML='<div class="upload-status upload-success">PDF: '+pdf.numPages+' pages</div>';SFX.success();}else{sa.innerHTML='<div class="upload-status" style="background:var(--yellow-soft);color:var(--orange);">PDF has little text</div>';SFX.error();}}catch(err){sa.innerHTML='<div class="upload-status" style="background:var(--red-soft);color:var(--red);">PDF failed</div>';SFX.error();}}}

function generateCards(){var text=document.getElementById('ai-text-input').value.trim();var dn=document.getElementById('ai-deck-name').value.trim();if(!text||text.length<20){showToast('Add more text');SFX.error();return;}if(!dn){showToast('Name your deck');SFX.error();return;}var cards=smartGenCards(text);if(cards.length===0){showToast('Could not extract content');SFX.error();return;}var color=DECK_COLORS[Math.floor(Math.random()*DECK_COLORS.length)];if(!S.decks)S.decks=[];S.decks.push({name:dn,subject:'AI Generated',color:color,cards:cards});save();addXP(20);SFX.success();if(S.decks.length>=5)unlock('five_decks');burst(window.innerWidth/2,300);document.getElementById('ai-preview').innerHTML='<div style="background:var(--green-soft);border:1.5px solid rgba(16,185,129,0.3);border-radius:var(--r-lg);padding:18px;text-align:center;"><div style="font-size:36px;margin-bottom:8px;">&#10003;</div><div style="font-size:16px;font-weight:800;margin-bottom:6px;color:var(--text);">Generated '+cards.length+' flashcards!</div><button class="btn btn-primary" onclick="SFX.tap();openDeck('+(S.decks.length-1)+');switchFcTab(\'study\',null)">Study Now</button></div>';}

function smartGenCards(text){var cards=[];var lines=text.split('\n').map(function(l){return l.trim();}).filter(function(l){return l.length>3;});lines.forEach(function(line){var m=line.match(/^([A-Z][^:;\-\n]{2,50}?)\s*[:;\-\u2013\u2014]\s*(.{10,300})$/);if(m)cards.push({front:'What is '+m[1].trim()+'?',back:m[2].trim()});});lines.forEach(function(line){var m=line.match(/^\d+[\.\)]\s*([^:;\-]{3,50})\s*[:;\-\u2013\u2014]\s*(.{10,300})$/);if(m&&!cards.some(function(c){return c.front.includes(m[1].trim());}))cards.push({front:'Define: '+m[1].trim(),back:m[2].trim()});});for(var i=0;i<lines.length-1;i++){if(lines[i].endsWith('?')&&lines[i].length>10&&lines[i+1].length>5&&!lines[i+1].endsWith('?')){cards.push({front:lines[i],back:lines[i+1]});i++;}}if(cards.length<8){var sents=text.replace(/([.!])\s+/g,'$1|').split('|').map(function(s){return s.trim();}).filter(function(s){return s.length>25&&s.length<350&&!s.endsWith('?');});sents.forEach(function(sent){if(cards.length>=30)return;var m=sent.match(/^(The\s+)?([A-Z][a-zA-Z\s]{2,30}?)\s+(is|are|was|were|refers to|means|involves|consists of|contains|produces|causes|results in|helps|allows|enables|provides)\s+(.{10,250})$/i);if(m){var subj=m[2].trim();var verb=m[3].trim();var rest=m[4].trim();if(!cards.some(function(c){return c.front.toLowerCase().includes(subj.toLowerCase());})){if(verb==='is'||verb==='are'||verb==='was'||verb==='were'||verb==='refers to'||verb==='means'){cards.push({front:'What '+verb+' '+subj+'?',back:subj+' '+verb+' '+rest});}else{cards.push({front:'What does '+subj+' '+verb+'?',back:subj+' '+verb+' '+rest});}}}});}if(cards.length<5){var ss=text.replace(/([.!])\s+/g,'$1|').split('|').map(function(s){return s.trim();}).filter(function(s){return s.length>30&&s.length<250;});ss.slice(0,10).forEach(function(sent){if(cards.length>=30)return;var words=sent.split(' ');if(words.length>=6){var ki=Math.min(Math.floor(words.length*0.4),words.length-2);var kw=words[ki].replace(/[.,;!?]/g,'');if(kw.length>3){var blanked=words.map(function(w,j){return j===ki?'_____':w;}).join(' ');cards.push({front:'Fill in: '+blanked,back:kw});}}});}var seen={};return cards.filter(function(c){var k=(c.front+c.back).slice(0,60).toLowerCase();if(seen[k])return false;seen[k]=true;return true;}).slice(0,30);}

// ══════════ BLURTING ══════════
var blurtPhase='source',blurtSrc='',blurtTxt='',blurtTimerInt=null,blurtSecs=120;
function initBlurt(){blurtPhase='source';blurtSrc='';blurtTxt='';renderBlurt();}
function renderBlurt(){var el=document.getElementById('blurt-body');if(blurtPhase==='source'){el.innerHTML='<div class="phase-badge" style="background:var(--blue-soft);color:var(--blue);border:1px solid rgba(59,130,246,0.3);">Step 1: Enter Source Material</div><div style="font-size:13px;color:var(--text2);margin-bottom:10px;">Paste or type what you want to memorize.</div><textarea class="form-input" id="blurt-src" placeholder="Paste your notes here..." style="min-height:200px;margin-bottom:12px;">'+blurtSrc+'</textarea><button class="btn btn-primary btn-full" onclick="SFX.tap();startBlurt()">Start Blurting</button>';}else if(blurtPhase==='blurt'){el.innerHTML='<div class="phase-badge" style="background:var(--pink-soft);color:var(--pink);border:1px solid rgba(236,72,153,0.3);">Step 2: Write Everything You Remember</div><div class="blurt-timer-big" id="bt-timer">2:00</div><textarea class="form-input" id="blurt-txt" placeholder="Write from memory..." style="min-height:210px;margin-bottom:12px;"></textarea><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"><button class="btn btn-secondary" onclick="SFX.erase();var t=document.getElementById(\'blurt-txt\');if(t){t.value=\'\';t.focus();}showToast(\'Cleared\');">Clear</button><button class="btn btn-primary" onclick="SFX.tap();endBlurt()">Done - Compare</button></div>';startBlurtTimer();}else{el.innerHTML='<div class="phase-badge" style="background:var(--green-soft);color:var(--green);border:1px solid rgba(16,185,129,0.3);">Step 3: Compare and Identify Gaps</div><div class="compare-grid"><div class="compare-box"><h5>Source</h5>'+esc(blurtSrc)+'</div><div class="compare-box"><h5>Your Recall</h5>'+(blurtTxt?esc(blurtTxt):'<span style="opacity:0.4;">Nothing written</span>')+'</div></div><div style="background:var(--yellow-soft);border:1.5px solid rgba(251,191,36,0.3);border-radius:var(--r);padding:14px;margin-bottom:12px;font-size:13px;line-height:1.6;color:var(--text2);">Look at what you missed!</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"><button class="btn btn-primary" onclick="SFX.tap();initBlurt()">Try Again</button><button class="btn btn-secondary" onclick="SFX.tap();switchNav(\'home\')">Done</button></div>';}}
function startBlurt(){blurtSrc=document.getElementById('blurt-src').value.trim();if(!blurtSrc){showToast('Add source material first');SFX.error();return;}blurtTxt='';blurtPhase='blurt';blurtSecs=120;renderBlurt();}
function startBlurtTimer(){clearInterval(blurtTimerInt);blurtTimerInt=setInterval(function(){blurtSecs--;var m=Math.floor(blurtSecs/60),s=blurtSecs%60;var el=document.getElementById('bt-timer');if(el)el.textContent=m+':'+String(s).padStart(2,'0');if(blurtSecs<=0){clearInterval(blurtTimerInt);endBlurt();}},1000);}
function endBlurt(){clearInterval(blurtTimerInt);var ta=document.getElementById('blurt-txt');if(ta)blurtTxt=ta.value.trim();blurtPhase='compare';S.blurtCt=(S.blurtCt||0)+1;addXP(15);logSession('blurting');unlock('first_blurt');if(S.blurtCt>=10)unlock('blurt_10');save();SFX.correct();renderBlurt();}

// ══════════ CORNELL ══════════
function initCornell(){renderCornell();}
function renderCornell(){document.getElementById('cornell-body').innerHTML='<div style="font-size:13px;color:var(--text2);margin-bottom:12px;line-height:1.6;"><strong style="color:var(--text);">Cornell Notes:</strong> Questions left, notes right. Summarize below.</div><div class="cornell-grid"><div><div class="cornell-lbl">Questions</div><textarea class="form-input" id="cn-q" placeholder="What causes...?" style="min-height:200px;"></textarea></div><div><div class="cornell-lbl">Notes</div><textarea class="form-input" id="cn-n" placeholder="Detailed notes..." style="min-height:200px;"></textarea></div></div><div style="margin-top:10px;"><div class="cornell-lbl">Summary</div><textarea class="form-input" id="cn-s" placeholder="Key takeaways..." style="min-height:70px;"></textarea></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;"><button class="btn btn-primary" onclick="SFX.tap();saveCornell()">Save Notes</button><button class="btn btn-secondary" onclick="SFX.tap();cornellQuiz()">Quiz Mode</button></div>';}
function saveCornell(){addXP(10);logSession('question');SFX.correct();showToast('Notes saved! +10 XP');}
function cornellQuiz(){var q=document.getElementById('cn-q').value,n=document.getElementById('cn-n').value;if(!q||!n){showToast('Fill in questions and notes first');SFX.error();return;}document.getElementById('cornell-body').innerHTML='<div class="phase-badge" style="background:var(--green-soft);color:var(--green);border:1px solid rgba(16,185,129,0.3);">Quiz Mode</div><div class="compare-box" style="margin-bottom:12px;">'+q.split('\n').filter(Boolean).map(function(l){return'<div style="margin-bottom:6px;">'+esc(l)+'</div>';}).join('')+'</div><textarea class="form-input" placeholder="Write answers..." style="min-height:160px;margin-bottom:10px;"></textarea><button class="btn btn-primary btn-full" onclick="SFX.tap();renderCornell()">Back to Notes</button>';}

// ══════════ FEYNMAN ══════════
var feynStep=0;
function initFeynman(){feynStep=0;renderFeynman();}
function renderFeynman(){var steps=['Concept','Explain','Gaps','Simplify'];document.getElementById('feynman-body').innerHTML='<div class="feynman-steps">'+steps.map(function(s,i){return'<div class="feynman-step '+(i===feynStep?'active':'')+'" onclick="SFX.tap();feynStep='+i+';renderFeynman();">'+(i+1)+'. '+s+'</div>';}).join('')+'</div>'+(feynStep===0?'<div style="font-size:13px;color:var(--text2);margin-bottom:12px;">What concept do you want to understand deeply?</div><input class="form-input" placeholder="Concept name" style="margin-bottom:10px;"><textarea class="form-input" placeholder="What you already know..." style="min-height:180px;margin-bottom:12px;"></textarea><button class="btn btn-primary btn-full" onclick="SFX.tap();feynStep=1;renderFeynman();">Next: Explain</button>':feynStep===1?'<div style="font-size:13px;color:var(--text2);margin-bottom:12px;">Explain as if teaching a 10-year-old!</div><textarea class="form-input" placeholder="So basically..." style="min-height:240px;margin-bottom:12px;"></textarea><button class="btn btn-primary btn-full" onclick="SFX.tap();feynStep=2;renderFeynman();">Next: Find Gaps</button>':feynStep===2?'<div style="font-size:13px;color:var(--text2);margin-bottom:12px;">Where did you get stuck?</div><textarea class="form-input" placeholder="I got confused when..." style="min-height:200px;margin-bottom:12px;"></textarea><button class="btn btn-primary btn-full" onclick="SFX.tap();feynStep=3;renderFeynman();">Next: Simplify</button>':'<div style="font-size:13px;color:var(--text2);margin-bottom:12px;">Write the simplest explanation after reviewing.</div><textarea class="form-input" placeholder="Final explanation..." style="min-height:200px;margin-bottom:12px;"></textarea><button class="btn btn-primary btn-full" onclick="SFX.tap();saveFeynman()">Complete!</button>');}
function saveFeynman(){S.feynmanCt=(S.feynmanCt||0)+1;addXP(20);logSession('feynman');if(S.feynmanCt>=5)unlock('feynman_5');save();SFX.success();showToast('Feynman done! +20 XP');feynStep=0;renderFeynman();}

// ══════════ RRR ══════════
var rrrPhase='read',_rrrSrc='',_rrrRec='';
function initRRR(){rrrPhase='read';_rrrSrc='';_rrrRec='';renderRRR();}
function renderRRR(){var el=document.getElementById('rrr-body');el.innerHTML='<div class="rrr-btns"><div class="rrr-btn '+(rrrPhase==='read'?'active':'')+'" onclick="SFX.tap();rrrPhase=\'read\';renderRRR()">Read</div><div class="rrr-btn '+(rrrPhase==='recite'?'active':'')+'" onclick="SFX.tap();rrrPhase=\'recite\';renderRRR()">Recite</div><div class="rrr-btn '+(rrrPhase==='review'?'active':'')+'" onclick="SFX.tap();rrrPhase=\'review\';renderRRR()">Review</div></div>'+(rrrPhase==='read'?'<div style="font-size:13px;color:var(--text2);margin-bottom:10px;">Step 1: Read carefully then move to Recite.</div><textarea class="form-input" id="rrr-src" placeholder="Paste reading material..." style="min-height:200px;margin-bottom:12px;">'+_rrrSrc+'</textarea><button class="btn btn-primary btn-full" onclick="SFX.tap();_rrrSrc=document.getElementById(\'rrr-src\').value;rrrPhase=\'recite\';renderRRR()">I Read It - Recite Now</button>':rrrPhase==='recite'?'<div style="font-size:13px;color:var(--text2);margin-bottom:10px;">Step 2: Write what you remember!</div><div class="compare-box" style="margin-bottom:10px;">Source hidden!</div><textarea class="form-input" id="rrr-rec" placeholder="Write from memory..." style="min-height:200px;margin-bottom:12px;">'+_rrrRec+'</textarea><button class="btn btn-primary btn-full" onclick="SFX.tap();_rrrRec=document.getElementById(\'rrr-rec\').value;rrrPhase=\'review\';renderRRR()">Compare - Review</button>':'<div style="font-size:13px;color:var(--text2);margin-bottom:10px;">Step 3: Compare what you missed.</div><div class="compare-grid"><div class="compare-box"><h5>Original</h5>'+(_rrrSrc?esc(_rrrSrc):'(empty)')+'</div><div class="compare-box"><h5>Your Recall</h5>'+(_rrrRec?esc(_rrrRec):'(empty)')+'</div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;"><button class="btn btn-primary" onclick="SFX.tap();rrrDone()">Done!</button><button class="btn btn-secondary" onclick="SFX.tap();rrrPhase=\'read\';renderRRR()">Again</button></div>');}
function rrrDone(){addXP(15);logSession('rrr');save();SFX.success();showToast('RRR complete! +15 XP');rrrPhase='read';renderRRR();}

// ══════════ WHITEBOARD ══════════
var wbCtx=null,wbDrawing=false,wbColor='#a78bfa',wbSize=4,wbTool='pen',wbBg='#f5f0ff';
function initWB(){wbBg=currentTheme==='dark'?'#16132a':'#f5f0ff';renderWBToolbar();var c=document.getElementById('wbCanvas');var w=c.parentElement;var nc=c.cloneNode(false);c.parentNode.replaceChild(nc,c);var cv=document.getElementById('wbCanvas');cv.width=w.clientWidth||380;cv.height=w.clientHeight||400;wbCtx=cv.getContext('2d');wbCtx.lineCap='round';wbCtx.lineJoin='round';wbCtx.fillStyle=wbBg;wbCtx.fillRect(0,0,cv.width,cv.height);var lp=null;function gXY(e){var r=cv.getBoundingClientRect();var s=e.touches?e.touches[0]:e;return{x:(s.clientX-r.left)*(cv.width/r.width),y:(s.clientY-r.top)*(cv.height/r.height)};}function st(e){e.preventDefault();wbDrawing=true;lp=gXY(e);if(wbTool==='pen'){wbCtx.beginPath();wbCtx.moveTo(lp.x,lp.y);}}function mv(e){e.preventDefault();if(!wbDrawing)return;var p=gXY(e);if(wbTool==='eraser'){wbCtx.globalCompositeOperation='source-over';wbCtx.strokeStyle=wbBg;wbCtx.lineWidth=wbSize*5;wbCtx.beginPath();wbCtx.moveTo(lp.x,lp.y);wbCtx.lineTo(p.x,p.y);wbCtx.stroke();}else{wbCtx.globalCompositeOperation='source-over';wbCtx.strokeStyle=wbColor;wbCtx.lineWidth=wbSize;wbCtx.lineTo(p.x,p.y);wbCtx.stroke();wbCtx.beginPath();wbCtx.moveTo(p.x,p.y);}lp=p;}function en(e){e.preventDefault();wbDrawing=false;lp=null;}cv.addEventListener('mousedown',st);cv.addEventListener('mousemove',mv);cv.addEventListener('mouseup',en);cv.addEventListener('mouseleave',en);cv.addEventListener('touchstart',st,{passive:false});cv.addEventListener('touchmove',mv,{passive:false});cv.addEventListener('touchend',en,{passive:false});}
function renderWBToolbar(){var cls=['#a78bfa','#f472b6','#34d399','#fbbf24','#60a5fa','#fb923c','#ffffff','#ef4444'];document.getElementById('wb-toolbar').innerHTML='<div class="wb-colors">'+cls.map(function(c){return'<div class="wb-color '+(c===wbColor?'sel':'')+'" style="background:'+c+';" onclick="wbColor=\''+c+'\';document.querySelectorAll(\'.wb-color\').forEach(function(e){e.classList.remove(\'sel\');});this.classList.add(\'sel\');SFX.pop();"></div>';}).join('')+'</div><div class="wb-sizes">'+[2,5,10,18].map(function(s,i){return'<div class="wb-sz '+(s===wbSize?'sel':'')+'" onclick="wbSize='+s+';document.querySelectorAll(\'.wb-sz\').forEach(function(e){e.classList.remove(\'sel\');});this.classList.add(\'sel\');SFX.pop();">'+['S','M','L','XL'][i]+'</div>';}).join('')+'</div><div class="wb-tools"><div class="wb-tool '+(wbTool==='pen'?'sel':'')+'" onclick="wbTool=\'pen\';document.querySelectorAll(\'.wb-tool\').forEach(function(e){e.classList.remove(\'sel\');});this.classList.add(\'sel\');SFX.tap();">Pen</div><div class="wb-tool '+(wbTool==='eraser'?'sel':'')+'" onclick="wbTool=\'eraser\';document.querySelectorAll(\'.wb-tool\').forEach(function(e){e.classList.remove(\'sel\');});this.classList.add(\'sel\');SFX.tap();">Erase</div></div>';}
function wbClear(){var c=document.getElementById('wbCanvas');if(wbCtx){wbCtx.fillStyle=wbBg;wbCtx.fillRect(0,0,c.width,c.height);}showToast('Cleared');SFX.erase();}
function wbSave(){addXP(10);logSession('whiteboard');unlock('first_wb');save();SFX.success();showToast('Saved! +10 XP');goBack();}

// ══════════ DIAGRAM ══════════
var diagNodes=[],diagEdges=[],diagColor='#8b5cf6',diagConnectMode=false,diagConnectFrom=null;
function initDiag(){diagNodes=[];diagEdges=[];diagConnectMode=false;diagConnectFrom=null;renderDiagToolbar();renderDiagCanvas();}
function renderDiagToolbar(){var cls=['#8b5cf6','#ec4899','#10b981','#fbbf24','#3b82f6','#f97316','#14b8a6'];document.getElementById('diag-toolbar').innerHTML='<div style="display:flex;gap:5px;">'+cls.map(function(c){return'<div class="diag-color '+(c===diagColor?'sel':'')+'" style="background:'+c+';" onclick="diagColor=\''+c+'\';document.querySelectorAll(\'.diag-color\').forEach(function(e){e.classList.remove(\'sel\');});this.classList.add(\'sel\');SFX.pop();"></div>';}).join('')+'</div><input class="diag-add-input" id="diag-node-input" placeholder="Node label..." maxlength="40" onkeydown="if(event.key===\'Enter\'){event.preventDefault();addDiagNode();}"><button class="btn btn-primary btn-xs" onclick="SFX.tap();addDiagNode()">Add</button>';}
function renderDiagCanvas(){var wrap=document.getElementById('diag-wrap');var nEl=document.getElementById('diag-nodes');var cv=document.getElementById('diagCanvas');cv.width=wrap.clientWidth||380;cv.height=wrap.clientHeight||300;var ctx=cv.getContext('2d');ctx.clearRect(0,0,cv.width,cv.height);ctx.strokeStyle='rgba(139,92,246,0.35)';ctx.lineWidth=2;diagEdges.forEach(function(edge){if(diagNodes[edge[0]]&&diagNodes[edge[1]]){var na=diagNodes[edge[0]],nb=diagNodes[edge[1]];ctx.beginPath();ctx.moveTo(na.x+na.w/2,na.y+na.h/2);ctx.lineTo(nb.x+nb.w/2,nb.y+nb.h/2);ctx.stroke();}});if(diagNodes.length===0){nEl.innerHTML='<div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--text3);gap:8px;pointer-events:none;"><span style="font-size:44px;">🗺️</span><span style="font-size:14px;font-weight:800;color:var(--text);">Add your first node</span></div>';return;}nEl.innerHTML=diagNodes.map(function(n,i){return'<div class="diag-node '+(i===0?'root':'')+'" id="dn'+i+'" style="left:'+n.x+'px;top:'+n.y+'px;background:'+n.color+'20;border-color:'+n.color+';color:'+n.color+';" onmousedown="diagMD(event,'+i+')" ontouchstart="diagTS(event,'+i+')">'+esc(n.label)+'<div class="diag-node-del" onclick="event.stopPropagation();delDN('+i+')">x</div></div>';}).join('');}
function addDiagNode(){var inp=document.getElementById('diag-node-input');var label=(inp?inp.value:'').trim();if(!label){showToast('Type a label');SFX.error();return;}var wrap=document.getElementById('diag-wrap');var W=wrap.clientWidth||380,H=wrap.clientHeight||300;var isR=diagNodes.length===0;var x=isR?(W/2-60):Math.max(10,Math.min(W-140,20+Math.random()*(W-160)));var y=isR?(H/2-25):Math.max(10,Math.min(H-80,20+Math.random()*(H-100)));if(!isR)diagEdges.push([0,diagNodes.length]);diagNodes.push({label:label,x:x,y:y,color:diagColor,w:120,h:50});if(inp)inp.value='';renderDiagCanvas();SFX.correct();setTimeout(function(){var el=document.getElementById('dn'+(diagNodes.length-1));if(el){diagNodes[diagNodes.length-1].w=el.offsetWidth;diagNodes[diagNodes.length-1].h=el.offsetHeight;}renderDiagCanvas();},50);}
function delDN(i){diagNodes.splice(i,1);diagEdges=diagEdges.filter(function(e){return e[0]!==i&&e[1]!==i;}).map(function(e){return[e[0]>i?e[0]-1:e[0],e[1]>i?e[1]-1:e[1]];});renderDiagCanvas();SFX.erase();}
function diagMD(e,i){if(diagConnectMode){if(diagConnectFrom===null){diagConnectFrom=i;showToast('Click target');}else{if(diagConnectFrom!==i){diagEdges.push([diagConnectFrom,i]);renderDiagCanvas();SFX.correct();}diagConnectFrom=null;}return;}e.preventDefault();e.stopPropagation();var wrap=document.getElementById('diag-wrap');var r=wrap.getBoundingClientRect();var ox=e.clientX-r.left-diagNodes[i].x,oy=e.clientY-r.top-diagNodes[i].y;var mm=function(ev){diagNodes[i].x=Math.max(0,Math.min(ev.clientX-r.left-ox,r.width-40));diagNodes[i].y=Math.max(0,Math.min(ev.clientY-r.top-oy,r.height-30));var el=document.getElementById('dn'+i);if(el){el.style.left=diagNodes[i].x+'px';el.style.top=diagNodes[i].y+'px';}renderDiagCanvas();};var mu=function(){document.removeEventListener('mousemove',mm);document.removeEventListener('mouseup',mu);};document.addEventListener('mousemove',mm);document.addEventListener('mouseup',mu);}
function diagTS(e,i){if(diagConnectMode){if(diagConnectFrom===null){diagConnectFrom=i;showToast('Tap target');}else{if(diagConnectFrom!==i){diagEdges.push([diagConnectFrom,i]);renderDiagCanvas();SFX.correct();}diagConnectFrom=null;}return;}e.preventDefault();e.stopPropagation();var wrap=document.getElementById('diag-wrap');var r=wrap.getBoundingClientRect();var t0=e.touches[0];var ox=t0.clientX-r.left-diagNodes[i].x,oy=t0.clientY-r.top-diagNodes[i].y;var tm=function(ev){ev.preventDefault();var t=ev.touches[0];diagNodes[i].x=Math.max(0,Math.min(t.clientX-r.left-ox,r.width-40));diagNodes[i].y=Math.max(0,Math.min(t.clientY-r.top-oy,r.height-30));var el=document.getElementById('dn'+i);if(el){el.style.left=diagNodes[i].x+'px';el.style.top=diagNodes[i].y+'px';}renderDiagCanvas();};var te=function(){document.removeEventListener('touchmove',tm);document.removeEventListener('touchend',te);};document.addEventListener('touchmove',tm,{passive:false});document.addEventListener('touchend',te);}
function diagConnect(){diagConnectMode=!diagConnectMode;diagConnectFrom=null;showToast(diagConnectMode?'Connect ON':'Connect OFF');SFX.tap();}
function diagClear(){diagNodes=[];diagEdges=[];renderDiagCanvas();showToast('Cleared');SFX.erase();}
function diagSave(){S.diagCt=(S.diagCt||0)+1;addXP(15);logSession('diagram');if(S.diagCt>=5)unlock('diagram_5');save();SFX.success();showToast('Saved! +15 XP');}

// ══════════ SCHEDULE ══════════
function renderSched(){var today=new Date();var days=['Su','Mo','Tu','We','Th','Fr','Sa'];document.getElementById('sched-week').innerHTML=days.map(function(d,i){var dt=new Date(today);dt.setDate(today.getDate()-today.getDay()+i);var ds=dt.toDateString();var isT=i===today.getDay();var has=S.sessions.some(function(s){return new Date(s.date).toDateString()===ds;});var isR=(S.restDays||[]).indexOf(ds)>=0;return'<div class="sched-day '+(isT?'today':'')+' '+(has?'has':'')+' '+(isR?'rest':'')+'"><div class="sched-dlbl">'+d+'</div><div class="sched-dnum">'+dt.getDate()+'</div></div>';}).join('');}
function renderSessList(){var tm={};TECHNIQUES.forEach(function(t){tm[t.id]=t;});var el=document.getElementById('sess-list');var rc=[].concat(S.sessions).reverse().slice(0,8);if(!rc.length){el.innerHTML='<div style="text-align:center;padding:28px;color:var(--text3);font-size:14px;font-weight:700;">No sessions yet!</div>';return;}el.innerHTML=rc.map(function(s){var t=tm[s.technique];return'<div class="sess-item"><div class="sess-dot" style="background:'+(t?t.cval:'var(--purple)')+'"></div><div class="sess-info"><h4>'+(t?t.icon+' ':'')+(s.subject||t&&t.name||s.technique)+'</h4><p>'+new Date(s.date).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})+(s.time?' at '+s.time:'')+'</p></div><div class="sess-time">'+(s.duration||0)+' min</div></div>';}).join('');}

function showAddSessionModal(){tpH=2;tpM=0;tpAMPM='PM';updateTimeDisplay();document.getElementById('session-modal').classList.add('show');SFX.whoosh();}
function hideAddSessionModal(){document.getElementById('session-modal').classList.remove('show');SFX.tap();}
function confirmAddSession(){var subj=document.getElementById('modal-subject').value.trim();var tech=document.getElementById('modal-technique').value;var dur=parseInt(document.getElementById('modal-duration').value)||30;if(!subj){showToast('Enter a subject');SFX.error();return;}var timeStr=tpH+':'+String(tpM).padStart(2,'0')+' '+tpAMPM;logSession(tech,subj,dur,timeStr);unlock('first_sched');hideAddSessionModal();renderSched();renderSessList();showToast('Session added! +5 XP');addXP(5);burst(window.innerWidth/2,window.innerHeight/2);}
function updateTimeDisplay(){document.getElementById('modal-time-display').textContent=tpH+':'+String(tpM).padStart(2,'0')+' '+tpAMPM+' - Tap to change';}

function showTimePicker(){var presets=[{l:'6:00 AM',h:6,m:0,a:'AM'},{l:'8:00 AM',h:8,m:0,a:'AM'},{l:'10:00 AM',h:10,m:0,a:'AM'},{l:'12:00 PM',h:12,m:0,a:'PM'},{l:'2:00 PM',h:2,m:0,a:'PM'},{l:'4:00 PM',h:4,m:0,a:'PM'},{l:'6:00 PM',h:6,m:0,a:'PM'},{l:'8:00 PM',h:8,m:0,a:'PM'},{l:'10:00 PM',h:10,m:0,a:'PM'}];document.getElementById('time-presets').innerHTML=presets.map(function(p){return'<div class="time-preset" onclick="tpH='+p.h+';tpM='+p.m+';tpAMPM=\''+p.a+'\';updateTP();SFX.pop();">'+p.l+'</div>';}).join('');updateTP();document.getElementById('time-modal').classList.add('show');SFX.whoosh();}
function hideTimePicker(){document.getElementById('time-modal').classList.remove('show');SFX.tap();}
function updateTP(){document.getElementById('tp-hour').textContent=String(tpH).padStart(2,'0');document.getElementById('tp-min').textContent=String(tpM).padStart(2,'0');document.getElementById('tp-pm-am').classList.toggle('active',tpAMPM==='AM');document.getElementById('tp-pm-pm').classList.toggle('active',tpAMPM==='PM');}
function spinTime(type,dir){SFX.pop();if(type==='h'){tpH+=dir;if(tpH>12)tpH=1;if(tpH<1)tpH=12;}else{tpM+=dir*5;if(tpM>=60)tpM=0;if(tpM<0)tpM=55;}updateTP();}
function setAMPM(v){tpAMPM=v;updateTP();SFX.select();}
function confirmTimePick(){updateTimeDisplay();hideTimePicker();SFX.correct();}

function toggleRest(){if(!S.restDays)S.restDays=[];var today=new Date().toDateString();var idx=S.restDays.indexOf(today);if(idx>=0){S.restDays.splice(idx,1);showToast('Rest day removed');SFX.tap();}else{S.restDays.push(today);showToast('Rest day set');SFX.select();if(S.restDays.length>=3)unlock('study_balance');}save();renderSched();}
function logSession(tech,subj,dur,time){if(!S.sessions)S.sessions=[];S.sessions.push({technique:tech,subject:subj||'',date:new Date().toISOString(),duration:dur||0,time:time||''});var today=new Date().toDateString();if(S.lastStudy!==today){var y=new Date();y.setDate(y.getDate()-1);S.streak=S.lastStudy===y.toDateString()?(S.streak||0)+1:1;S.lastStudy=today;if(S.streak>=3)unlock('streak_3');if(S.streak>=7)unlock('streak_7');}S.mins=(S.mins||0)+(dur||25);if(S.mins>=600)unlock('hours_10');if(S.mins>=3000)unlock('hours_50');save();}

// ══════════ TIMER ══════════
function toggleTimer(){if(timerOn){clearInterval(timerInt);timerOn=false;document.getElementById('timer-btn').textContent='Resume';SFX.tap();}else{timerOn=true;document.getElementById('timer-btn').textContent='Pause';SFX.tap();timerInt=setInterval(function(){timerSecs--;updateTimerDisplay();if(timerSecs<=0){clearInterval(timerInt);timerOn=false;pomoCt++;if(timerPhase==='focus'){logSession(S.topTech||'flashcards','Pomodoro',25);addXP(25);unlock('first_timer');SFX.timer();showToast('Focus done! +25 XP');burst(window.innerWidth/2,300);timerPhase=pomoCt%4===0?'longbreak':'shortbreak';timerSecs=timerPhase==='longbreak'?900:300;}else{timerPhase='focus';timerSecs=1500;SFX.timer();showToast('Break over!');}document.getElementById('timer-ring').className='timer-ring '+(timerPhase==='focus'?'focus-mode':'break-mode');document.getElementById('timer-phase').textContent=timerPhase==='focus'?'Focus Session':timerPhase==='shortbreak'?'Short Break':'Long Break';document.getElementById('timer-btn').textContent='Start';updateTimerDisplay();}},1000);}}
function resetTimer(){clearInterval(timerInt);timerOn=false;timerPhase='focus';timerSecs=1500;document.getElementById('timer-btn').textContent='Start';document.getElementById('timer-phase').textContent='Focus Session';document.getElementById('timer-ring').className='timer-ring';updateTimerDisplay();SFX.tap();}
function updateTimerDisplay(){var m=Math.floor(timerSecs/60),s=timerSecs%60;var el=document.getElementById('timer-ring');if(el)el.textContent=m+':'+String(s).padStart(2,'0');}

// ══════════ ACHIEVEMENTS ══════════
function unlock(key){if(!S.ach)S.ach=[];if(S.ach.indexOf(key)>=0)return;S.ach.push(key);var def=ACHIEVEMENTS_DEF.find(function(a){return a.key===key;});if(!def)return;var xpMap={common:10,rare:25,epic:50,legendary:100};addXP(xpMap[def.rarity]||10);var nonLeg=ACHIEVEMENTS_DEF.filter(function(a){return a.rarity!=='legendary';}).map(function(a){return a.key;});if(nonLeg.every(function(k){return S.ach.indexOf(k)>=0;}))setTimeout(function(){unlock('all_ach');},600);save();showAchPop(def.icon,def.name);SFX.unlock();}
function showAchPop(icon,name){document.getElementById('ap-icon').textContent=icon;document.getElementById('ap-name').textContent=name;var p=document.getElementById('ach-popup');p.classList.add('show');burst(window.innerWidth/2,60,['#fbbf24','#f97316','#8b5cf6'],12);setTimeout(function(){p.classList.remove('show');},3500);}
function renderAch(){if(!S.ach)S.ach=[];document.getElementById('ach-count').textContent=S.ach.length+'/'+ACHIEVEMENTS_DEF.length;document.getElementById('ach-grid').innerHTML=ACHIEVEMENTS_DEF.map(function(a){var u=S.ach.indexOf(a.key)>=0;var isNew=S.ach.slice(-3).indexOf(a.key)>=0&&u;return'<div class="ach-card '+(u?'unlocked':'locked')+'">'+(isNew?'<div class="ach-new">NEW</div>':'')+'<span class="ach-icon">'+a.icon+'</span><div class="ach-name">'+a.name+'</div><div class="ach-desc">'+(u?a.desc:'???')+'</div><span class="ach-rarity r-'+a.rarity+'">'+a.rarity+'</span></div>';}).join('');}

// ══════════ XP & UTILS ══════════
function addXP(n){S.xp=(S.xp||0)+n;save();}
var _toastT=null;
function showToast(msg){var t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(_toastT);_toastT=setTimeout(function(){t.classList.remove('show');},2800);}

// ══════════ INIT ══════════
hideSplash();
</script>
</body>
</html>